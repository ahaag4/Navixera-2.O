<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Public Transit Dashboard — Navixera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-rgb: 37, 99, 235;
      --primary-hover: #1d4ed8;
      --secondary-color: #64748b;
      --accent-color: #8b5cf6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --card-border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --font-family: 'Inter', sans-serif;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .navbar {
      background: var(--card-bg);
      box-shadow: var(--shadow-sm);
      padding: 0.75rem 0;
    }

    .navbar-brand {
      font-weight: 700;
      display: flex;
      align-items: center;
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .navbar-brand svg {
      color: var(--primary-color);
    }

    .card {
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      background: var(--card-bg);
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .card-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--card-border);
      padding: 1rem 1.25rem;
      font-weight: 600;
    }

    .card-title {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .card-body {
      padding: 1.25rem;
    }

    #map {
      height: 70vh;
      min-height: 500px;
      border-radius: var(--border-radius);
      z-index: 1;
    }

    .map-card {
      position: relative;
      overflow: hidden;
    }

    .map-controls {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 401;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .map-controls .btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
    }

    .map-controls .btn:hover {
      transform: scale(1.05);
    }

    .loader-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      transition: opacity 0.3s ease;
      opacity: 1;
      backdrop-filter: blur(4px);
    }

    .loader-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .search-panel {
      padding: 1.5rem;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .search-group {
      margin-bottom: 1.5rem;
    }

    .form-control {
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius-sm);
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .btn {
      border-radius: var(--border-radius-sm);
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-light {
      background-color: white;
      border-color: var(--card-border);
    }

    .btn-light:hover {
      background-color: #f8f9fa;
      border-color: #d1d7e0;
    }

    .result-list {
      max-height: 350px;
      overflow-y: auto;
      margin-top: 1rem;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--card-border);
      background: var(--card-bg);
    }

    .vehicle-item {
      cursor: pointer;
      transition: var(--transition);
      border-radius: var(--border-radius-sm);
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
      padding: 1rem;
      border-bottom: 1px solid var(--card-border);
    }

    .vehicle-item:last-child {
      border-bottom: none;
    }

    .vehicle-item:hover {
      background-color: #f1f5f9;
      transform: translateX(4px);
    }

    .sidebar {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 380px;
      max-width: 90%;
      z-index: 1020;
      box-shadow: var(--shadow-lg);
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      max-height: calc(100vh - 100px);
      display: flex;
      flex-direction: column;
    }

    .sidebar.is-visible {
      transform: translateX(0);
    }

    .sidebar .card-body {
      overflow-y: auto;
      flex: 1;
    }

    #stopList .list-group-item {
      cursor: pointer;
      transition: var(--transition);
      border: none;
      border-bottom: 1px solid var(--card-border);
      padding: 0.75rem 1rem;
    }

    #stopList .list-group-item:last-child {
      border-bottom: none;
    }

    #stopList .list-group-item:hover {
      background-color: #f8fafc;
    }

    .bus-stop-panel {
      position: fixed;
      top: 80px;
      left: 20px;
      width: 380px;
      max-width: 90%;
      z-index: 1020;
      box-shadow: var(--shadow-lg);
      transform: translateX(-120%);
      transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      max-height: calc(100vh - 100px);
      display: flex;
      flex-direction: column;
    }

    .bus-stop-panel.is-visible {
      transform: translateX(0);
    }

    .bus-stop-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .bus-stop-title {
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
    }

    .see-all-link {
      color: var(--primary-color);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .see-all-link:hover {
      text-decoration: underline;
    }

    .bus-stop-item {
      padding: 1rem;
      border-bottom: 1px solid var(--card-border);
      background: #f8fafc;
      border-radius: var(--border-radius-sm);
      margin-bottom: 1rem;
    }

    .bus-stop-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .bus-stop-distance {
      color: var(--success-color);
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .bus-route {
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--card-border);
    }

    .bus-route-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .bus-route-item {
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: var(--border-radius-sm);
      margin-bottom: 0.75rem;
    }

    .bus-route-item:last-child {
      margin-bottom: 0;
    }

    .bus-number {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .bus-destination {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .bus-timings {
      color: var(--success-color);
      font-size: 0.85rem;
      font-weight: 500;
    }

    .user-location-icon {
      background-color: var(--primary-color);
      border: 2px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.5);
      animation: pulse 1.5s infinite;
    }

    .user-dot {
      background-color: var(--primary-color);
      border-radius: 50%;
      width: 100%;
      height: 100%;
    }

    .badge {
      font-weight: 500;
      padding: 0.35em 0.65em;
      border-radius: 50px;
      font-size: 0.75em;
    }

    .badge-primary {
      background-color: var(--primary-color);
    }

    .badge-success {
      background-color: var(--success-color);
    }

    .badge-warning {
      background-color: var(--warning-color);
    }

    /* Bus icon styling */
    .bus-icon {
      background-color: var(--primary-color);
      border-radius: 50% 50% 0 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      transform: translate(-12px, -12px);
    }

    .bus-icon::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid var(--primary-color);
    }

    @keyframes pulse {
      0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0); }
      100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0); }
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1080;
    }

    .toast {
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-lg);
      border: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .vehicle-item:nth-child(1) { animation-delay: 0.1s; }
    .vehicle-item:nth-child(2) { animation-delay: 0.2s; }
    .vehicle-item:nth-child(3) { animation-delay: 0.3s; }

    /* ETA specific styles */
    .eta-badge {
      background-color: var(--success-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .eta-info-panel {
      background-color: #f0f9ff;
      border-left: 4px solid var(--primary-color);
      padding: 0.75rem;
      border-radius: 4px;
      margin-top: 1rem;
    }

    /* Alert badge styles */
    .alert-badge {
      background-color: var(--warning-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    /* Flash Screen */
    .flash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 1s ease;
    }

    .flash-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .logo-container {
      text-align: center;
    }

    .logo-container svg {
      animation: bounce 1s infinite alternate;
    }

    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }

    /* Responsive adjustments */
    @media (max-width: 1199.98px) {
      .sidebar, .bus-stop-panel {
        width: 340px;
      }
    }

    @media (max-width: 991.98px) {
      #map {
        height: 50vh;
      }
      
      .sidebar, .bus-stop-panel {
        width: 320px;
      }
    }

    @media (max-width: 767.98px) {
      .sidebar {
        width: 100%;
        max-width: 100%;
        right: 0;
        bottom: 0;
        top: auto;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        transform: translateY(120%);
      }

      .sidebar.is-visible {
        transform: translateY(0);
      }

      .sidebar .card-body {
        max-height: 50vh;
      }

      .bus-stop-panel {
        width: 100%;
        max-width: 100%;
        left: 0;
        bottom: 0;
        top: auto;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        transform: translateY(120%);
      }

      .bus-stop-panel.is-visible {
        transform: translateY(0);
      }
      
      .map-controls {
        flex-direction: row;
        bottom: 15px;
        top: auto;
      }
      
      .navbar-brand {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 575.98px) {
      .container {
        padding-left: 12px;
        padding-right: 12px;
      }
      
      .search-panel {
        padding: 1rem;
      }
      
      .card-body {
        padding: 1rem;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Utility classes */
    .text-muted {
      color: var(--text-muted) !important;
    }

    .text-primary {
      color: var(--primary-color) !important;
    }

    .text-success {
      color: var(--success-color) !important;
    }

    .fw-medium {
      font-weight: 500;
    }

    .divider {
      height: 1px;
      background-color: var(--card-border);
      margin: 1rem 0;
    }

    /* Profile Section */
    .profile-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    /* History Section */
    .history-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    /* Payment Section */
    .payment-methods {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .payment-method {
      flex: 1;
      text-align: center;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .payment-method.active {
      border-color: var(--primary-color);
      background-color: rgba(37, 99, 235, 0.1);
    }

    .payment-method img {
      max-height: 30px;
    }

    .upi-input {
      display: block;
    }

    .card-input, .wallet-input {
      display: none;
    }

    /* Ticket Calculation */
    .ticket-summary {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .ticket-summary p {
      margin-bottom: 5px;
    }

    .ticket-summary .final-amount {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
    }
  </style>
</head>
<body>
  <!-- Flash Screen -->
  <div id="flashScreen" class="flash-screen">
    <div class="logo-container">
      <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="currentColor" class="bi bi-broadcast-pin" viewBox="0 0 16 16">
        <path d="M3.05 3.05a7 7 0 0 0 0 9.9.5.5 0 0 1-.707.707 8 8 0 0 1 0-11.314.5.5 0 0 1 .707.707zm2.122 2.122a4 4 0 0 0 0 5.656.5.5 0 1 1-.708.708 5 5 0 0 1 0-7.072.5.5 0 0 1 .708.708zm5.656-.708a.5.5 0 0 1 .708 0 5 5 0 0 1 0 7.072.5.5 0 1 1-.708-.708 4 4 0 0 0 0-5.656.5.5 0 0 1 0-.708zm2.122-2.12a.5.5 0 0 1 .707 0 8 8 0 0 1 0 11.314.5.5 0 0 1-.707-.707 7 7 0 0 0 0-9.9.5.5 0 0 1 0-.707zM8 10a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/>
        <path d="M12.06 13.94a.5.5 0 0 1 .707 0l1.414 1.414a.5.5 0 0 1-.707.707L12.06 14.647a.5.5 0 0 1 0-.707zM4.646 13.94a.5.5 0 0 0-.707 0L2.525 15.354a.5.5 0 0 0 .707.707L4.646 14.647a.5.5 0 0 0 0-.707zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zM8 9a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
      </svg>
      <h1>Navixera</h1>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-broadcast-pin" viewBox="0 0 16 16" style="margin-right: 8px;">
          <path d="M3.05 3.05a7 7 0 0 0 0 9.9.5.5 0 0 1-.707.707 8 8 0 0 1 0-11.314.5.5 0 0 1 .707.707zm2.122 2.122a4 4 0 0 0 0 5.656.5.5 0 1 1-.708.708 5 5 0 0 1 0-7.072.5.5 0 0 1 .708.708zm5.656-.708a.5.5 0 0 1 .708 0 5 5 0 0 1 0 7.072.5.5 0 1 1-.708-.708 4 4 0 0 0 0-5.656.5.5 0 0 1 0-.708zm2.122-2.12a.5.5 0 0 1 .707 0 8 8 0 0 1 0 11.314.5.5 0 0 1-.707-.707 7 7 0 0 0 0-9.9.5.5 0 0 1 0-.707zM8 10a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/>
          <path d="M12.06 13.94a.5.5 0 0 1 .707 0l1.414 1.414a.5.5 0 0 1-.707.707L12.06 14.647a.5.5 0 0 1 0-.707zM4.646 13.94a.5.5 0 0 0-.707 0L2.525 15.354a.5.5 0 0 0 .707.707L4.646 14.647a.5.5 0 0 0 0-.707zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zM8 9a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
        </svg>
        Navixera — Live Transit
      </a>
      <div class="d-flex align-items-center">
        <span class="badge bg-primary me-2">Live</span>
        <small class="text-muted d-none d-md-block">AI-Powered Transit Tracking</small>
      </div>
      <div id="authSection" class="ms-auto d-flex align-items-center gap-2">
        <button id="loginBtn" class="btn btn-outline-primary">Login</button>
        <div id="profileSection" class="profile-section d-none">
          <div class="profile-avatar" id="profileAvatar">U</div>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span id="userName">User</span>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" id="editProfileBtn">Edit Profile</a></li>
              <li><a class="dropdown-item" href="#" id="historyBtn">History</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
      <select id="languageSelect" class="form-select ms-2" style="width: auto;">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
        <option value="bn">Bengali</option>
        <option value="te">Telugu</option>
        <option value="mr">Marathi</option>
        <option value="ta">Tamil</option>
        <option value="ur">Urdu</option>
        <option value="gu">Gujarati</option>
        <option value="kn">Kannada</option>
        <option value="ml">Malayalam</option>
        <option value="pa">Punjabi</option>
        <option value="or">Odia</option>
        <option value="as">Assamese</option>
        <option value="mai">Maithili</option>
        <option value="sa">Sanskrit</option>
        <option value="ks">Kashmiri</option>
        <option value="ne">Nepali</option>
        <option value="sd">Sindhi</option>
        <option value="kok">Konkani</option>
        <option value="doi">Dogri</option>
        <option value="mni">Manipuri</option>
        <option value="bho">Bhojpuri</option>
        <option value="fr">French</option>
      </select>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <div class="card map-card">
          <div id="map"></div>
          <div class="map-controls">
            <button id="locateBtn" class="btn btn-light" title="Find My Location">
              <i class="bi bi-geo-alt-fill text-primary"></i>
            </button>
            <button id="showBusStopsBtn" class="btn btn-light" title="Show Bus Stops">
              <i class="bi bi-signpost text-primary"></i>
            </button>
            <button id="lostBagBtn" class="btn btn-light" title="Report Lost Bag" data-bs-toggle="modal" data-bs-target="#lostBagModal">
              <i class="bi bi-bag-x text-danger"></i>
            </button>
            <button id="safetyBtn" class="btn btn-light" title="Safety Alert">
              <i class="bi bi-shield-fill-exclamation text-danger"></i>
            </button>
            <button id="buyTicketBtn" class="btn btn-light" title="Buy Ticket" data-bs-toggle="modal" data-bs-target="#buyTicketModal">
              <i class="bi bi-ticket-perforated text-success"></i>
            </button>
            <button id="chatBtn" class="btn btn-light" title="Chat" data-bs-toggle="modal" data-bs-target="#chatModal">
              <i class="bi bi-chat-dots text-info"></i>
            </button>
          </div>
          <div class="loader-overlay" id="loader">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card search-panel">
          <h5 class="card-title mb-3">Find Your Ride</h5>
          <div class="search-group">
            <label for="searchVehicle" class="form-label fw-medium">Bus Number</label>
            <input type="text" id="searchVehicle" class="form-control" placeholder="e.g., C-306,306">
            <button id="searchVehicleBtn" class="btn btn-primary w-100 mt-2">
              <i class="bi bi-search"></i> Search Vehicle
            </button>
          </div>
          <div class="divider"></div>
          <div class="search-group">
            <label for="searchRouteFrom" class="form-label fw-medium">Route Planner</label>
            <input type="text" id="searchRouteFrom" class="form-control" placeholder="From (e.g., Central Station)">
            <input type="text" id="searchRouteTo" class="form-control mt-2" placeholder="To (e.g., North Park)">
            <button id="searchRouteBtn" class="btn btn-primary w-100 mt-2">
              <i class="bi bi-signpost-split"></i> Find Route
            </button>
          </div>
          
          <!-- Bus Alert Section -->
          <div class="divider"></div>
          <div class="search-group">
            <label class="form-label fw-medium">Bus Arrival Alerts</label>
            <select id="busAlertSelect" class="form-select">
              <option value="">Select a bus to track</option>
            </select>
            <button id="setAlertBtn" class="btn btn-warning w-100 mt-2">
              <i class="bi bi-bell"></i> Set Arrival Alert
            </button>
          </div>
          
          <div class="mt-auto">
            <h6 class="fw-medium mb-2">Search Results</h6>
            <div class="result-list" id="searchResults">
              <div class="text-center p-3 text-muted">
                <i class="bi bi-inbox d-block fs-1 mb-2"></i>
                <span>Your search results will appear here</span>
              </div>
            </div>
          </div>
          <!-- Points Section -->
          <div class="divider"></div>
          <div class="search-group" id="pointsSection" style="display: none;">
            <h6 class="fw-medium mb-2">Your Points: <span id="userPoints">0</span></h6>
            <button id="dailyCheckInBtn" class="btn btn-success w-100">Daily Check-In</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="card sidebar" id="vehicleDetails">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0" id="vehicleTitle">Vehicle Details</h5>
      <button type="button" class="btn-close" aria-label="Close" id="closeSidebarBtn"></button>
    </div>
    <div class="card-body">
      <div id="vehicleInfo" class="mb-3"></div>
      <h6 class="fw-medium mb-3">Route Stops</h6>
      <ul id="stopList" class="list-group list-group-flush"></ul>
      <!-- Progress Bar -->
      <div class="mt-3">
        <h6 class="fw-medium mb-2">Bus Progress</h6>
        <div class="progress" id="busProgress">
          <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card bus-stop-panel" id="busStopPanel">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Nearest Bus Stop</h5>
      <button type="button" class="btn-close" aria-label="Close" id="closeBusStopPanelBtn"></button>
    </div>
    <div class="card-body" id="busStopContent">
      <!-- Dynamically populated -->
    </div>
  </div>

  <!-- Lost Bag Modal -->
  <div class="modal fade" id="lostBagModal" tabindex="-1" aria-labelledby="lostBagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lostBagModalLabel">Report Lost Bag</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>If you've forgotten your bag on a bus, we can notify the driver. This only works when you're near the bus.</p>
          <div class="mb-3">
            <label for="lostBagBusSelect" class="form-label">Select Bus</label>
            <select class="form-select" id="lostBagBusSelect">
              <option value="">Select the bus you were on</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="bagDescription" class="form-label">Bag Description</label>
            <textarea class="form-control" id="bagDescription" rows="3" placeholder="Describe your bag (color, size, distinctive features)"></textarea>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmLocation">
            <label class="form-check-label" for="confirmLocation">
              I confirm I'm currently near this bus
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="reportLostBagBtn">Report Lost Bag</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Buy Ticket Modal -->
  <div class="modal fade" id="buyTicketModal" tabindex="-1" aria-labelledby="buyTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="buyTicketModalLabel">Buy Ticket</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="ticketBusSelect" class="form-label">Select Bus</label>
                <select class="form-select" id="ticketBusSelect">
                  <option value="">Select a bus</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="passengerCount" class="form-label">Number of Passengers</label>
                <select class="form-select" id="passengerCount">
                  <option value="1">1 Passenger</option>
                  <option value="2">2 Passengers</option>
                  <option value="3">3 Passengers</option>
                  <option value="4">4 Passengers</option>
                  <option value="5">5 Passengers</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="ticketFrom" class="form-label">From</label>
                <select class="form-select" id="ticketFrom">
                  <option value="">Select starting stop</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="ticketTo" class="form-label">To</label>
                <select class="form-select" id="ticketTo">
                  <option value="">Select destination stop</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="mb-3" id="pointsRedeemSection" style="display: none;">
            <label for="usePoints" class="form-label">Use Points for Discount</label>
            <input type="number" class="form-control" id="usePoints" min="0" placeholder="Enter points to use">
            <small class="text-muted">100 points = ₹10 discount</small>
          </div>
          
          <div class="ticket-summary">
            <h6>Ticket Summary</h6>
            <div id="ticketSummaryContent">
              <p>Please select a bus and stops to see fare details</p>
            </div>
          </div>
          
          <div class="payment-methods mb-3">
            <div class="payment-method active" data-method="upi">
              <i class="bi bi-phone"></i> UPI
            </div>
          </div>
          
          <div class="mb-3 upi-input">
            <label for="upiId" class="form-label">UPI ID</label>
            <input type="text" class="form-control" id="upiId" placeholder="Enter your UPI ID">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="payTicketBtn">Pay Now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Please login to access all features</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="window.location.href='login.html'">Go to Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="profileName" class="form-label">Name</label>
            <input type="text" class="form-control" id="profileName" placeholder="Enter name">
          </div>
          <div class="mb-3">
            <label for="profileEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="profileEmail" placeholder="Enter email" disabled>
          </div>
          <div class="mb-3">
            <label for="profilePhone" class="form-label">Phone</label>
            <input type="tel" class="form-control" id="profilePhone" placeholder="Enter phone number">
          </div>
          <div class="mb-3">
            <label for="emergencyContacts" class="form-label">Emergency Contacts (comma-separated)</label>
            <input type="text" class="form-control" id="emergencyContacts" placeholder="e.g., +1234567890, +0987654321">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveProfileBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">Transaction History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="historyTabs">
            <ul class="nav nav-tabs" id="historyTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tickets-tab" data-bs-toggle="tab" data-bs-target="#tickets" type="button" role="tab" aria-controls="tickets" aria-selected="true">Tickets</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="points-tab" data-bs-toggle="tab" data-bs-target="#points" type="button" role="tab" aria-controls="points" aria-selected="false">Points</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab" aria-controls="alerts" aria-selected="false">Alerts</button>
              </li>
            </ul>
            <div class="tab-content p-3" id="historyTabContent">
              <div class="tab-pane fade show active" id="tickets" role="tabpanel" aria-labelledby="tickets-tab">
                <div id="ticketHistoryList"></div>
              </div>
              <div class="tab-pane fade" id="points" role="tabpanel" aria-labelledby="points-tab">
                <div id="pointsHistoryList"></div>
              </div>
              <div class="tab-pane fade" id="alerts" role="tabpanel" aria-labelledby="alerts-tab">
                <div id="alertHistoryList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="chatModalLabel">Bus Chat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <select id="chatBusSelect" class="form-select mb-3">
            <option value="">Select Bus to Chat</option>
          </select>
          <div id="chatMessages" class="border p-3 mb-3" style="height: 200px; overflow-y: auto;"></div>
          <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Type message...">
            <button class="btn btn-primary" id="sendChatBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Safety Alert Modal -->
  <div class="modal fade" id="safetyModal" tabindex="-1" aria-labelledby="safetyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="safetyModalLabel">Safety Alert</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Your location and emergency alert will be sent to:</p>
          <ul>
            <li>Nearest police station</li>
            <li>Emergency contacts in your profile</li>
          </ul>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Only use this in case of emergency!
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmSafetyAlertBtn">Send Alert</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <script>
    (function () {
      'use strict';

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
        authDomain: "svms-c0232.firebaseapp.com",
        databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
        projectId: "svms-c0232",
        storageBucket: "svms-c0232.appspot.com",
        messagingSenderId: "359201898609",
        appId: "1:359201898609:web:893ef076207abb06471bd0"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();
      const functions = firebase.functions ? firebase.functions() : null;

      // DOM Element Caching
      const dom = {
        flashScreen: document.getElementById('flashScreen'),
        loader: document.getElementById('loader'),
        locateBtn: document.getElementById('locateBtn'),
        showBusStopsBtn: document.getElementById('showBusStopsBtn'),
        searchVehicleInput: document.getElementById('searchVehicle'),
        searchVehicleBtn: document.getElementById('searchVehicleBtn'),
        searchRouteFrom: document.getElementById('searchRouteFrom'),
        searchRouteTo: document.getElementById('searchRouteTo'),
        searchRouteBtn: document.getElementById('searchRouteBtn'),
        searchResults: document.getElementById('searchResults'),
        vehicleDetails: document.getElementById('vehicleDetails'),
        vehicleTitle: document.getElementById('vehicleTitle'),
        vehicleInfo: document.getElementById('vehicleInfo'),
        stopList: document.getElementById('stopList'),
        closeSidebarBtn: document.getElementById('closeSidebarBtn'),
        busStopPanel: document.getElementById('busStopPanel'),
        busStopContent: document.getElementById('busStopContent'),
        closeBusStopPanelBtn: document.getElementById('closeBusStopPanelBtn'),
        toastContainer: document.querySelector('.toast-container'),
        busAlertSelect: document.getElementById('busAlertSelect'),
        setAlertBtn: document.getElementById('setAlertBtn'),
        lostBagBtn: document.getElementById('lostBagBtn'),
        lostBagBusSelect: document.getElementById('lostBagBusSelect'),
        reportLostBagBtn: document.getElementById('reportLostBagBtn'),
        bagDescription: document.getElementById('bagDescription'),
        confirmLocation: document.getElementById('confirmLocation'),
        loginBtn: document.getElementById('loginBtn'),
        profileSection: document.getElementById('profileSection'),
        profileAvatar: document.getElementById('profileAvatar'),
        userName: document.getElementById('userName'),
        logoutBtn: document.getElementById('logoutBtn'),
        editProfileBtn: document.getElementById('editProfileBtn'),
        historyBtn: document.getElementById('historyBtn'),
        buyTicketBtn: document.getElementById('buyTicketBtn'),
        ticketBusSelect: document.getElementById('ticketBusSelect'),
        payTicketBtn: document.getElementById('payTicketBtn'),
        profileName: document.getElementById('profileName'),
        profileEmail: document.getElementById('profileEmail'),
        profilePhone: document.getElementById('profilePhone'),
        saveProfileBtn: document.getElementById('saveProfileBtn'),
        historyList: document.getElementById('historyList'),
        ticketHistoryList: document.getElementById('ticketHistoryList'),
        pointsHistoryList: document.getElementById('pointsHistoryList'),
        alertHistoryList: document.getElementById('alertHistoryList'),
        safetyBtn: document.getElementById('safetyBtn'),
        languageSelect: document.getElementById('languageSelect'),
        pointsSection: document.getElementById('pointsSection'),
        userPoints: document.getElementById('userPoints'),
        dailyCheckInBtn: document.getElementById('dailyCheckInBtn'),
        chatBtn: document.getElementById('chatBtn'),
        chatBusSelect: document.getElementById('chatBusSelect'),
        chatMessages: document.getElementById('chatMessages'),
        chatInput: document.getElementById('chatInput'),
        sendChatBtn: document.getElementById('sendChatBtn'),
        busProgress: document.getElementById('busProgress'),
        emergencyContacts: document.getElementById('emergencyContacts'),
        usePoints: document.getElementById('usePoints'),
        pointsRedeemSection: document.getElementById('pointsRedeemSection'),
        ticketFrom: document.getElementById('ticketFrom'),
        ticketTo: document.getElementById('ticketTo'),
        passengerCount: document.getElementById('passengerCount'),
        ticketSummaryContent: document.getElementById('ticketSummaryContent'),
        upiId: document.getElementById('upiId'),
        confirmSafetyAlertBtn: document.getElementById('confirmSafetyAlertBtn')
      };

      // State & Map Variables
      let map;
      const markers = {};
      let stopMarkers = {};
      let markerGroup = L.featureGroup();
      let routeLayer = L.featureGroup();
      let userLocationMarker = null;
      let userLocation = null;
      let vehiclesData = {};
      let busStops = [];
      let busAlerts = {};
      let alertCheckInterval = null;
      const alertSound = new Audio('https://freesound.org/data/previews/66/66157_634166-lq.mp3');
      let currentUser = null;
      let userData = {};
      let currentChatBus = null;
      let currentSelectedBus = null;
      let languages = {
        en: {
          title: 'Live Public Transit Dashboard — Navixera',
          findRide: 'Find Your Ride',
          vehicleNumber: 'Vehicle Number',
          routePlanner: 'Route Planner',
          busAlerts: 'Bus Arrival Alerts',
          searchResults: 'Search Results',
          vehicleDetails: 'Vehicle Details',
          routeStops: 'Route Stops',
          nearestBusStop: 'Nearest Bus Stop',
          reportLostBag: 'Report Lost Bag',
          buyTicket: 'Buy Ticket',
          login: 'Login',
          profile: 'Profile',
          editProfile: 'Edit Profile',
          logout: 'Logout',
          history: 'History',
          safetyAlert: 'Safety Alert',
          chat: 'Chat'
        },
        hi: {
          title: 'लाइव पब्लिक ट्रांजिट डैशबोर्ड — नविक्सेरा',
          findRide: 'अपनी सवारी खोजें',
          vehicleNumber: 'वाहन संख्या',
          routePlanner: 'मार्ग योजनाकार',
          busAlerts: 'बस आगमन अलर्ट',
          searchResults: 'खोज परिणाम',
          vehicleDetails: 'वाहन विवरण',
          routeStops: 'मार्ग स्टॉप',
          nearestBusStop: 'निकटतम बस स्टॉप',
          reportLostBag: 'खोया बैग रिपोर्ट करें',
          buyTicket: 'टिकट खरीदें',
          login: 'लॉगिन',
          profile: 'प्रोफाइल',
          editProfile: 'प्रोफाइल संपादित करें',
          logout: 'लॉगआउट',
          history: 'इतिहास',
          safetyAlert: 'सुरक्षा अलर्ट',
          chat: 'चैट'
        },
        bn: {
          title: 'লাইভ পাবলিক ট্রানজিট ড্যাশবোর্ড — নাভিক্সেরা',
          findRide: 'আপনার যাত্রা খুঁজুন',
          vehicleNumber: 'যানবাহন নম্বর',
          routePlanner: 'রুট প্ল্যানার',
          busAlerts: 'বাস আগমন সতর্কতা',
          searchResults: 'অনুসন্ধান ফলাফল',
          vehicleDetails: 'যানবাহন বিবরণ',
          routeStops: 'রুট স্টপ',
          nearestBusStop: 'নিকটতম বাস স্টপ',
          reportLostBag: 'হারানো ব্যাগ রিপোর্ট করুন',
          buyTicket: 'টিকিট কিনুন',
          login: 'লগইন',
          profile: 'প্রোফাইল',
          editProfile: 'প্রোফাইল সম্পাদনা করুন',
          logout: 'লগআউট',
          history: 'ইতিহাস',
          safetyAlert: 'নিরাপত্তা সতর্কতা',
          chat: 'চ্যাট'
        },
        te: {
          title: 'లైవ్ పబ్లిక్ ట్రాన్సిట్ డాష్బోర్డ్ — నావిక్సెరా',
          findRide: 'మీ రైడ్ కనుగొనండి',
          vehicleNumber: 'వాహన నంబర్',
          routePlanner: 'రూట్ ప్లానర్',
          busAlerts: 'బస్సు రాక అలర్ట్లు',
          searchResults: 'శోధన ఫలితాలు',
          vehicleDetails: 'వాహన వివరాలు',
          routeStops: 'రూట్ స్టాప్స్',
          nearestBusStop: 'సమీప బస్ స్టాప్',
          reportLostBag: 'కోల్పోయిన బ్యాగ్ ని రిపోర్ట్ చేయండి',
          buyTicket: 'టికెట్ కొనండి',
          login: 'లాగిన్',
          profile: 'ప్రొఫైల్',
          editProfile: 'ప్రొఫైల్ సవరించు',
          logout: 'లాగ్అవుట్',
          history: 'చరిత్ర',
          safetyAlert: 'భద్రతా అలర్ట్',
          chat: 'చాట్'
        },
        fr: {
          title: 'Tableau de bord des transports publics en direct — Navixera',
          findRide: 'Trouvez votre trajet',
          vehicleNumber: 'Numéro de véhicule',
          routePlanner: 'Planificateur d\'itinéraire',
          busAlerts: 'Alertes d\'arrivée de bus',
          searchResults: 'Résultats de recherche',
          vehicleDetails: 'Détails du véhicule',
          routeStops: 'Arrêts d\'itinéraire',
          nearestBusStop: 'Arrêt de bus le plus proche',
          reportLostBag: 'Signaler un sac perdu',
          buyTicket: 'Acheter un billet',
          login: 'Connexion',
          profile: 'Profil',
          editProfile: 'Modifier le profil',
          logout: 'Déconnexion',
          history: 'Histoire',
          safetyAlert: 'Alerte de sécurité',
          chat: 'Chat'
        }
      };
      let currentLang = 'en';

      // Custom Bus Icon
      const createBusIcon = (color = '#2563eb') => {
        return L.divIcon({
          className: 'bus-marker',
          html: `<div class="bus-icon" style="background-color: ${color}">
                  <i class="bi bi-bus-front"></i>
                </div>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14],
          popupAnchor: [0, -14]
        });
      };

      const stopIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const userLocationIcon = L.divIcon({
        className: 'user-location-icon',
        html: `<div class="user-dot"></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        popupAnchor: [0, -12]
      });

      // Helper Functions
      const showLoader = () => dom.loader && dom.loader.classList && dom.loader.classList.remove('hidden');
      const hideLoader = () => dom.loader && dom.loader.classList && dom.loader.classList.add('hidden');

      const showToast = (message, type = 'info', ttl = 3500) => {
        try {
          if (!dom.toastContainer) {
            console.warn('No toast container found. Message:', message);
            return;
          }
          const toastEl = document.createElement('div');
          toastEl.className = `toast align-items-center text-bg-${type} border-0 show`;
          toastEl.setAttribute('role', 'alert');
          toastEl.setAttribute('aria-live', 'assertive');
          toastEl.innerHTML = `
            <div class="d-flex">
              <div class="toast-body d-flex align-items-center">
                <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'warning' ? 'bi-exclamation-triangle-fill' : type === 'danger' ? 'bi-x-circle-fill' : 'bi-info-circle-fill'} me-2"></i>
                ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>`;
          dom.toastContainer.appendChild(toastEl);
          const toast = new bootstrap.Toast(toastEl, { delay: ttl });
          toast.show();
          toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
          alertSound.play().catch(e => console.log('Audio play error', e));
        } catch (e) {
          console.error('showToast error', e);
        }
      };

      const parseGps = (gps) => {
        if (!gps) return null;
        if (typeof gps === 'object' && gps.latitude != null && gps.longitude != null) {
          return [Number(gps.latitude), Number(gps.longitude)];
        }
        const parts = String(gps).split(',').map(s => parseFloat(s.trim()));
        if (parts.length < 2 || !isFinite(parts[0]) || !isFinite(parts[1]) || (parts[0] === 0 && parts[1] === 0)) {
          return null;
        }
        return [parts[0], parts[1]];
      };

      const formatDistance = (distance) => {
        if (!isFinite(distance)) return 'N/A';
        if (distance < 1) {
          return `${Math.round(distance * 1000)} m`;
        }
        return `${distance.toFixed(2)} km`;
      };

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      };

      // Backend ETA Caller (optional; will fall back if functions not available)
      const getETA = async (vehicle, previousCoords, previousTime) => {
        if (!functions) {
          return { eta: 'N/A', nextStop: 'N/A', speed: 0 };
        }
        try {
          const calculateETA = functions.httpsCallable('calculateETA');
          const result = await calculateETA({ vehicle, previousCoords, previousTime });
          return result.data || { eta: 'N/A', nextStop: 'N/A', speed: 0 };
        } catch (err) {
          console.error('ETA calculation error:', err);
          // don't spam toasts; optional single warning
          return { eta: 'N/A', nextStop: 'N/A', speed: 0 };
        }
      };

      // Map Functions
      const initMap = () => {
        map = L.map('map').setView([19.0760, 72.8777], 12); // Centered on Mumbai
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        markerGroup.addTo(map);
        routeLayer.addTo(map);
      };

      const locateUser = () => {
        if (!navigator.geolocation) {
          showToast("Geolocation is not supported by your browser.", "warning");
          return Promise.reject("Geolocation not supported");
        }
        showToast("Locating you...", "info");
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              userLocation = [latitude, longitude];
              if (userLocationMarker) {
                userLocationMarker.setLatLng(userLocation);
              } else {
                userLocationMarker = L.marker(userLocation, { icon: userLocationIcon }).addTo(map);
                userLocationMarker.bindPopup("<b>You are here</b>");
              }
              map.flyTo(userLocation, 16);
              setTimeout(() => userLocationMarker.openPopup(), 1000);
              findNearestBusStops();
              detectLanguageByLocation(latitude, longitude);
              resolve();
            },
            (err) => {
              showToast("Unable to retrieve your location. Please check permissions.", "danger");
              reject(err);
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
          );
        });
      };

      const detectLanguageByLocation = async (lat, lon) => {
        // Mock: For India, set Hindi; else English
        if (lat > 8 && lat < 37 && lon > 68 && lon < 97) {
          currentLang = 'hi';
        } else {
          currentLang = 'en';
        }
        dom.languageSelect.value = currentLang;
        updateLanguage();
      };

      const updateLanguage = () => {
        document.title = languages[currentLang]?.title || languages.en.title;
        // Update other texts dynamically
        const elements = {
          '.search-panel h5': 'findRide',
          'label[for="searchVehicle"]': 'vehicleNumber',
          'label[for="searchRouteFrom"]': 'routePlanner',
          '.search-group label.fw-medium': 'busAlerts',
          '.card-title.mb-0': 'vehicleDetails',
          '.fw-medium.mb-3': 'routeStops',
          '.bus-stop-panel .card-title': 'nearestBusStop',
          '#lostBagModalLabel': 'reportLostBag',
          '#buyTicketModalLabel': 'buyTicket',
          '#loginModalLabel': 'login',
          '#editProfileModalLabel': 'editProfile',
          '#historyModalLabel': 'history',
          '#chatModalLabel': 'chat'
        };
        
        Object.entries(elements).forEach(([selector, key]) => {
          const element = document.querySelector(selector);
          if (element && languages[currentLang] && languages[currentLang][key]) {
            element.textContent = languages[currentLang][key];
          }
        });
      };

      const findNearestBusStops = () => {
        if (!userLocation || !Array.isArray(busStops) || busStops.length === 0) {
          showToast("Location or bus stops data not available.", "warning");
          return;
        }
        busStops.forEach(stop => {
          const coords = parseGps(stop.gps);
          if (coords) {
            stop.distance = calculateDistance(userLocation[0], userLocation[1], coords[0], coords[1]);
          } else {
            stop.distance = Infinity;
          }
        });
        busStops.sort((a, b) => a.distance - b.distance);
        if (busStops.length > 0 && busStops[0].distance !== Infinity) {
          showBusStopPanel(busStops[0]);
        } else {
          showToast("No valid bus stops found.", "warning");
        }
      };

      const showBusStopPanel = (stop) => {
        dom.busStopContent.innerHTML = `
          <div class="bus-stop-header">
            <h6 class="bus-stop-title">${stop.name || 'Unnamed Stop'}</h6>
            <a href="#" class="see-all-link" id="seeAllStops">
              See all stops <i class="bi bi-arrow-right"></i>
            </a>
          </div>
          <div class="bus-stop-item">
            <div class="bus-stop-name">${stop.name || 'Unnamed Stop'}</div>
            <div class="bus-stop-distance">
              <i class="bi bi-geo-alt"></i> ${formatDistance(stop.distance)} away
            </div>
          </div>
          ${(stop.vehicles || []).map(v => `
            <div class="bus-route">
              <h6 class="bus-route-title">${v.type || 'Unknown'}</h6>
              <div class="bus-route-item">
                <div class="bus-number">
                  <i class="bi bi-bus-front"></i> ${v.vehicleId || ''}
                </div>
                <div class="bus-destination">${v.routeName || 'N/A'}</div>
                <div class="bus-timings">${v.timings || 'Timings not available'}</div>
              </div>
            </div>
          `).join('') || '<div class="text-muted p-3 text-center"><i class="bi bi-info-circle"></i> No vehicles available at this stop.</div>'}
        `;
        dom.busStopPanel.classList.add('is-visible');

        // Handle "See all stops" click
        const seeAllLink = dom.busStopContent.querySelector('#seeAllStops');
        if (seeAllLink) {
          seeAllLink.addEventListener('click', (e) => {
            e.preventDefault();
            showAllStops();
          });
        }
      };

      const showAllStops = () => {
        // Ensure each stop has distance calculated (if userLocation present)
        if (userLocation) {
          busStops.forEach(stop => {
            const coords = parseGps(stop.gps);
            stop.distance = coords ? calculateDistance(userLocation[0], userLocation[1], coords[0], coords[1]) : Infinity;
          });
          busStops.sort((a, b) => a.distance - b.distance);
        }

        dom.busStopContent.innerHTML = `
          <div class="bus-stop-header">
            <h6 class="bus-stop-title">All Bus Stops</h6>
          </div>
          <ul class="list-group list-group-flush">
            ${busStops.map(stop => `
              <li class="list-group-item" data-stop-id="${stop.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${stop.name || 'Unnamed Stop'}</strong><br>
                    <small class="text-success"><i class="bi bi-geo-alt"></i> ${formatDistance(stop.distance)}</small>
                  </div>
                  <button class="btn btn-sm btn-outline-primary view-stop-btn">
                    <i class="bi bi-geo-alt"></i> View
                  </button>
                </div>
              </li>
            `).join('')}
          </ul>
        `;
        dom.busStopPanel.classList.add('is-visible');

        // Add event listeners for view buttons
        dom.busStopContent.querySelectorAll('.view-stop-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const stopId = btn.closest('.list-group-item').dataset.stopId;
            const stop = busStops.find(s => s.id == stopId);
            if (stop) {
              const coords = parseGps(stop.gps);
              if (coords) {
                map.flyTo(coords, 16);
                if (stopMarkers[stop.id]) {
                  setTimeout(() => stopMarkers[stop.id].openPopup(), 1000);
                }
              } else {
                showToast('Stop has no valid coordinates.', 'warning');
              }
            }
          });
        });
      };

      const drawVehicleRoute = (vehicle) => {
        routeLayer.clearLayers();
        Object.values(stopMarkers).forEach(marker => {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        });
        stopMarkers = {};
        const routePath = (vehicle.fullRoutePath || []).map(parseGps).filter(Boolean);
        if (routePath.length > 1) {
          L.polyline(routePath, { color: '#2563eb', weight: 5, opacity: 0.8 }).addTo(routeLayer);
        }
        const stops = vehicle.stops || [];
        stops.forEach((stop, index) => {
          const coords = parseGps(stop.gps);
          if (coords) {
            const marker = L.marker(coords, { icon: stopIcon }).addTo(routeLayer);
            marker.bindPopup(`
              <strong>Stop ${index + 1}:</strong> ${stop.name || 'Unnamed Stop'}<br>
              <small>Click to view on map</small>
            `);
            marker.on('click', () => {
              // nothing extra
            });
            stopMarkers[stop.id || `stop-${index}`] = marker;
            L.circleMarker(coords, {
              radius: 6,
              color: '#10b981',
              fillColor: '#fff',
              fillOpacity: 1,
              weight: 2
            }).addTo(routeLayer);
          }
        });
      };

      // UI Update Functions
      const showVehicleDetails = async (vid, vehicle) => {
        dom.vehicleTitle.textContent = `Vehicle: ${vid}`;

        // Calculate ETA for the detailed view
        let etaInfoForDetails = { eta: 'Calculating...', nextStop: 'N/A', speed: 0 };
        if (markers[vid]) {
          etaInfoForDetails = await getETA(vehicle, markers[vid].prevCoords, markers[vid].prevTime);
        }

        const status = etaInfoForDetails.speed > 5 ? 'Moving' : 'Stopped';

        // Create battery indicator
        const batteryLevel = vehicle.battery ?? 0;
        let batteryColor = 'success';
        let batteryIcon = 'bi-battery-full';

        if (batteryLevel < 20) {
          batteryColor = 'danger';
          batteryIcon = 'bi-battery';
        } else if (batteryLevel < 50) {
          batteryColor = 'warning';
          batteryIcon = 'bi-battery-half';
        }

        dom.vehicleInfo.innerHTML = `
          <div class="d-flex flex-wrap gap-3 mb-3">
            <div class="d-flex align-items-center">
              <i class="bi bi-bus-front text-primary me-2"></i>
              <span>${vehicle.vehicleType || 'Unknown'}</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-signpost text-primary me-2"></i>
              <span>${vehicle.routeName || 'N/A'}</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi ${batteryIcon} text-${batteryColor} me-2"></i>
              <span>${batteryLevel}%</span>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-3">
            <div class="d-flex align-items-center">
              <i class="bi bi-building text-primary me-2"></i>
              <span>${vehicle.companyName || 'N/A'}</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-speedometer2 text-primary me-2"></i>
              <span>${etaInfoForDetails.speed || 'N/A'} km/h</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="bi bi-info-circle text-primary me-2"></i>
              <span>Status: ${status}</span>
            </div>
          </div>
          <div class="eta-info-panel mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>Next Stop:</strong> ${etaInfoForDetails.nextStop}<br>
                <small>AI-Powered Prediction</small>
              </div>
              <span class="eta-badge">${etaInfoForDetails.eta}</span>
            </div>
          </div>
        `;

        dom.stopList.innerHTML = '';
        const stops = vehicle.stops || [];
        if (stops.length > 0) {
          stops.forEach((stop, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Stop ${index + 1}:</strong> ${stop.name || 'Unnamed Stop'}
                </div>
                <button class="btn btn-sm btn-outline-primary view-stop-btn" data-index="${index}">
                  <i class="bi bi-geo-alt"></i> View
                </button>
              </div>
            `;
            dom.stopList.appendChild(li);
            li.querySelector('.view-stop-btn').addEventListener('click', () => {
              const coords = parseGps(stop.gps);
              if (coords) {
                map.flyTo(coords, 16);
                const key = stop.id || `stop-${index}`;
                if (stopMarkers[key]) {
                  setTimeout(() => stopMarkers[key].openPopup(), 1000);
                }
              } else {
                showToast('Stop location not available.', 'warning');
              }
            });
          });
        } else {
          dom.stopList.innerHTML = '<li class="list-group-item text-muted text-center py-3"><i class="bi bi-info-circle"></i> No stops available.</li>';
        }

        // Update progress bar (mock: based on stops)
        const progress = (vehicle.currentStopIndex || 0) / (stops.length || 1) * 100;
        dom.busProgress.querySelector('.progress-bar').style.width = `${progress}%`;
        dom.busProgress.querySelector('.progress-bar').textContent = `${Math.round(progress)}%`;
        dom.busProgress.querySelector('.progress-bar').setAttribute('aria-valuenow', Math.round(progress));

        drawVehicleRoute(vehicle);
        dom.vehicleDetails.classList.add('is-visible');
      };

      const hideVehicleDetails = () => {
        dom.vehicleDetails.classList.remove('is-visible');
        routeLayer.clearLayers();
        Object.values(stopMarkers).forEach(marker => {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        });
        stopMarkers = {};
      };

      const hideBusStopPanel = () => dom.busStopPanel.classList.remove('is-visible');

      // Auth Functions
      const handleAuthState = (user) => {
        currentUser = user;
        if (user) {
          dom.loginBtn.style.display = 'none';
          dom.profileSection.classList.remove('d-none');
          dom.pointsSection.style.display = 'block';
          loadUserData(user.uid);
          updateTicketBusSelect();
          updateChatBusSelect();
          dom.pointsRedeemSection.style.display = 'block';
        } else {
          dom.loginBtn.style.display = 'block';
          dom.profileSection.classList.add('d-none');
          dom.pointsSection.style.display = 'none';
          userData = {};
          dom.userPoints.textContent = '0';
          dom.pointsRedeemSection.style.display = 'none';
        }
      };

      const logout = () => {
        auth.signOut().then(() => showToast('Logged out', 'info'));
      };

      const loadUserData = (uid) => {
        db.ref(`users/${uid}`).on('value', snap => {
          userData = snap.val() || { 
            points: 0, 
            history: [], 
            name: '', 
            email: '',
            phone: '',
            emergencyContacts: [] 
          };
          dom.userPoints.textContent = userData.points || 0;
          dom.userName.textContent = userData.name || 'User';
          dom.profileAvatar.textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
          
          // Update profile modal
          dom.profileName.value = userData.name || '';
          dom.profileEmail.value = userData.email || currentUser.email || '';
          dom.profilePhone.value = userData.phone || '';
          dom.emergencyContacts.value = (userData.emergencyContacts || []).join(', ');
        });
      };

      const saveProfile = () => {
        if (!currentUser) return;
        const name = dom.profileName.value;
        const phone = dom.profilePhone.value;
        const contacts = dom.emergencyContacts.value.split(',').map(c => c.trim());
        db.ref(`users/${currentUser.uid}`).update({ 
          name, 
          phone,
          emergencyContacts: contacts,
          email: currentUser.email
        })
          .then(() => {
            showToast('Profile updated', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
          });
      };

      const showEditProfile = () => {
        dom.profileName.value = userData.name || '';
        dom.profileEmail.value = currentUser.email || '';
        dom.profilePhone.value = userData.phone || '';
        dom.emergencyContacts.value = (userData.emergencyContacts || []).join(', ');
        new bootstrap.Modal(document.getElementById('editProfileModal')).show();
      };

      const showHistory = () => {
        // Load ticket history
        const ticketHistory = (userData.history || []).filter(h => h.type === 'Ticket Purchase');
        dom.ticketHistoryList.innerHTML = ticketHistory.length > 0 ? 
          ticketHistory.map(h => `
            <div class="history-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${h.details}</strong><br>
                  <small class="text-muted">${new Date(h.timestamp).toLocaleString()}</small>
                </div>
                <div class="text-end">
                  <span class="badge bg-success">₹${h.amount || '0'}</span><br>
                  <small class="text-muted">${h.passengers || 1} passenger(s)</small>
                </div>
              </div>
            </div>
          `).join('') : 
          '<div class="text-center p-3 text-muted">No ticket history yet.</div>';
        
        // Load points history
        const pointsHistory = (userData.history || []).filter(h => h.type === 'Points');
        dom.pointsHistoryList.innerHTML = pointsHistory.length > 0 ? 
          pointsHistory.map(h => `
            <div class="history-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${h.details}</strong><br>
                  <small class="text-muted">${new Date(h.timestamp).toLocaleString()}</small>
                </div>
                <div>
                  <span class="badge ${h.points > 0 ? 'bg-success' : 'bg-warning'}">${h.points > 0 ? '+' : ''}${h.points} points</span>
                </div>
              </div>
            </div>
          `).join('') : 
          '<div class="text-center p-3 text-muted">No points history yet.</div>';
        
        // Load alert history
        const alertHistory = (userData.history || []).filter(h => h.type === 'Safety Alert');
        dom.alertHistoryList.innerHTML = alertHistory.length > 0 ? 
          alertHistory.map(h => `
            <div class="history-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${h.details}</strong><br>
                  <small class="text-muted">${new Date(h.timestamp).toLocaleString()}</small>
                </div>
                <div>
                  <span class="badge bg-danger">Alert</span>
                </div>
              </div>
            </div>
          `).join('') : 
          '<div class="text-center p-3 text-muted">No alert history yet.</div>';
        
        new bootstrap.Modal(document.getElementById('historyModal')).show();
      };

      const dailyCheckIn = () => {
        if (!currentUser) return;
        const lastCheckIn = userData.lastCheckIn || 0;
        if (Date.now() - lastCheckIn > 86400000) { // 24 hours
          const newPoints = (userData.points || 0) + 10;
          const history = userData.history || [];
          history.push({ 
            type: 'Points', 
            details: 'Daily check-in', 
            points: 10,
            timestamp: Date.now() 
          });
          db.ref(`users/${currentUser.uid}`).update({ 
            points: newPoints, 
            lastCheckIn: Date.now(),
            history
          })
            .then(() => showToast('Checked in! +10 points', 'success'));
        } else {
          showToast('You can check in once per day.', 'warning');
        }
      };

      // Bus Alert Functions
      const updateBusAlertDropdown = () => {
        if (dom.busAlertSelect) dom.busAlertSelect.innerHTML = '<option value="">Select a bus to track</option>';
        if (dom.lostBagBusSelect) dom.lostBagBusSelect.innerHTML = '<option value="">Select the bus you were on</option>';

        Object.keys(vehiclesData).forEach(vid => {
          const routeName = vehiclesData[vid].routeName || 'Unknown Route';
          if (dom.busAlertSelect) {
            const option = document.createElement('option');
            option.value = vid;
            option.textContent = `${vid} - ${routeName}`;
            dom.busAlertSelect.appendChild(option);
          }
          if (dom.lostBagBusSelect) {
            const option2 = document.createElement('option');
            option2.value = vid;
            option2.textContent = `${vid} - ${routeName}`;
            dom.lostBagBusSelect.appendChild(option2);
          }
        });
      };

      const setBusAlert = () => {
        const selectedBus = dom.busAlertSelect ? dom.busAlertSelect.value : '';
        if (!selectedBus) {
          showToast('Please select a bus first.', 'warning');
          return;
        }

        busAlerts[selectedBus] = true;
        localStorage.setItem('busAlerts', JSON.stringify(busAlerts));
        showToast(`Alert set for bus ${selectedBus}. You'll be notified when it arrives near you.`, 'success');

        // Add visual indicator to the bus marker
        if (markers[selectedBus]) {
          markers[selectedBus].marker.setIcon(createBusIcon('#f59e0b'));
        }
      };

      const checkBusAlerts = () => {
        if (!userLocation) return;

        Object.keys(busAlerts).forEach(vid => {
          if (vehiclesData[vid] && markers[vid]) {
            const busCoords = parseGps(vehiclesData[vid].gps);
            if (busCoords) {
              const distance = calculateDistance(
                userLocation[0], userLocation[1],
                busCoords[0], busCoords[1]
              );

              // Notify if bus is within 500 meters
              if (distance < 0.5) {
                showToast(`Bus ${vid} is approaching! It's ${formatDistance(distance)} away.`, 'success', 5000);
                alertSound.play().catch(e => console.log('Audio play error', e));

                // Remove the alert after notifying
                delete busAlerts[vid];
                localStorage.setItem('busAlerts', JSON.stringify(busAlerts));

                // Reset bus icon color
                if (markers[vid]) {
                  markers[vid].marker.setIcon(createBusIcon());
                }
              }
            }
          }
        });
      };

      // Lost Bag Function
      const reportLostBag = () => {
        if (!currentUser) {
          showToast('Please login to report lost bag.', 'warning');
          return;
        }
        const selectedBus = dom.lostBagBusSelect ? dom.lostBagBusSelect.value : '';
        const description = dom.bagDescription ? dom.bagDescription.value.trim() : '';
        const confirmed = dom.confirmLocation ? dom.confirmLocation.checked : false;

        if (!selectedBus || !description) {
          showToast('Please select a bus and describe your bag.', 'warning');
          return;
        }

        if (!confirmed) {
          showToast('Please confirm that you are near the bus.', 'warning');
          return;
        }

        // Check if user is actually near the bus
        if (!userLocation || !vehiclesData[selectedBus]) {
          showToast('Unable to verify your location.', 'danger');
          return;
        }

        const busCoords = parseGps(vehiclesData[selectedBus].gps);
        if (!busCoords) {
          showToast('Unable to get bus location.', 'danger');
          return;
        }

        const distance = calculateDistance(
          userLocation[0], userLocation[1],
          busCoords[0], busCoords[1]
        );

        if (distance > 0.5) {
          showToast('You are not near the selected bus. Please move closer to report a lost bag.', 'warning');
          return;
        }

        // Send notification to driver/database
        db.ref(`public_transport/vehicles/${selectedBus}/notifications`).push({
          type: 'lost_bag',
          description: description,
          timestamp: Date.now(),
          userLocation: userLocation
        }).then(() => {
          showToast('Driver notified about your lost bag.', 'success');
          // hide modal if using bootstrap modal with id lostBagModal
          const modalEl = document.getElementById('lostBagModal');
          if (modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }
        }).catch(err => {
          console.error('Error reporting lost bag:', err);
          showToast('Failed to report lost bag. Please try again.', 'danger');
        });
      };

      // Buy Ticket Function
      const updateTicketBusSelect = () => {
        dom.ticketBusSelect.innerHTML = '<option value="">Select a bus</option>';
        Object.keys(vehiclesData).forEach(vid => {
          const option = document.createElement('option');
          option.value = vid;
          option.textContent = `${vid} - ${vehiclesData[vid].routeName || 'Unknown'}`;
          dom.ticketBusSelect.appendChild(option);
        });
      };

      const updateTicketStops = (busId) => {
        if (!busId || !vehiclesData[busId]) {
          dom.ticketFrom.innerHTML = '<option value="">Select starting stop</option>';
          dom.ticketTo.innerHTML = '<option value="">Select destination stop</option>';
          return;
        }

        const stops = vehiclesData[busId].stops || [];
        dom.ticketFrom.innerHTML = '<option value="">Select starting stop</option>';
        dom.ticketTo.innerHTML = '<option value="">Select destination stop</option>';

        stops.forEach((stop, index) => {
          const optionFrom = document.createElement('option');
          optionFrom.value = index;
          optionFrom.textContent = `${index + 1}. ${stop.name || 'Unnamed Stop'}`;
          dom.ticketFrom.appendChild(optionFrom);

          const optionTo = document.createElement('option');
          optionTo.value = index;
          optionTo.textContent = `${index + 1}. ${stop.name || 'Unnamed Stop'}`;
          dom.ticketTo.appendChild(optionTo);
        });

        // Auto-select nearest stop as "From" if user location is available
        if (userLocation && stops.length > 0) {
          let nearestStopIndex = 0;
          let minDistance = Infinity;

          stops.forEach((stop, index) => {
            const coords = parseGps(stop.gps);
            if (coords) {
              const distance = calculateDistance(
                userLocation[0], userLocation[1],
                coords[0], coords[1]
              );
              if (distance < minDistance) {
                minDistance = distance;
                nearestStopIndex = index;
              }
            }
          });

          if (minDistance < 2) { // Within 2km
            dom.ticketFrom.value = nearestStopIndex;
          }
        }

        // Calculate fare when stops are selected
        calculateTicketFare();
      };

      const calculateTicketFare = () => {
        const busId = dom.ticketBusSelect.value;
        const fromIndex = parseInt(dom.ticketFrom.value);
        const toIndex = parseInt(dom.ticketTo.value);
        const passengerCount = parseInt(dom.passengerCount.value) || 1;
        const pointsToUse = parseInt(dom.usePoints.value) || 0;

        if (!busId || isNaN(fromIndex) || isNaN(toIndex) || fromIndex >= toIndex) {
          dom.ticketSummaryContent.innerHTML = '<p>Please select a bus and valid stops to see fare details</p>';
          return;
        }

        // Calculate fare based on distance between stops
        const stops = vehiclesData[busId].stops || [];
        const baseFarePerKm = 5; // ₹5 per km
        let totalDistance = 0;

        // Calculate approximate distance between selected stops
        for (let i = fromIndex; i < toIndex; i++) {
          const stop1 = stops[i];
          const stop2 = stops[i + 1];
          const coords1 = parseGps(stop1.gps);
          const coords2 = parseGps(stop2.gps);
          
          if (coords1 && coords2) {
            totalDistance += calculateDistance(coords1[0], coords1[1], coords2[0], coords2[1]);
          } else {
            // If GPS data is missing, estimate 1km per stop
            totalDistance += 1;
          }
        }

        const baseFare = Math.max(10, Math.round(totalDistance * baseFarePerKm)); // Minimum ₹10
        const totalFare = baseFare * passengerCount;
        const discount = Math.min(pointsToUse / 10, totalFare); // 100 points = ₹10 discount
        const finalFare = Math.max(0, totalFare - discount);

        dom.ticketSummaryContent.innerHTML = `
          <div class="d-flex justify-content-between">
            <span>Base Fare (${passengerCount} passenger${passengerCount > 1 ? 's' : ''}):</span>
            <span>₹${totalFare}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Points Discount:</span>
            <span>-₹${discount.toFixed(2)}</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between final-amount">
            <span>Final Amount:</span>
            <span>₹${finalFare.toFixed(2)}</span>
          </div>
          <small class="text-muted">Distance: ${totalDistance.toFixed(1)} km</small>
        `;

        return finalFare;
      };

      const buyTicket = () => {
        if (!currentUser) {
          showToast('Please login to buy ticket.', 'warning');
          return;
        }
        const busId = dom.ticketBusSelect.value;
        const fromIndex = parseInt(dom.ticketFrom.value);
        const toIndex = parseInt(dom.ticketTo.value);
        const passengerCount = parseInt(dom.passengerCount.value) || 1;
        const pointsToUse = parseInt(dom.usePoints.value) || 0;
        const upiId = dom.upiId.value;
        const finalFare = calculateTicketFare();
        
        if (!busId || isNaN(fromIndex) || isNaN(toIndex) || fromIndex >= toIndex) {
          showToast('Please select a bus and valid stops.', 'warning');
          return;
        }
        if (!upiId) {
          showToast('Please enter your UPI ID.', 'warning');
          return;
        }
        if (pointsToUse > (userData.points || 0)) {
          showToast('Insufficient points.', 'warning');
          return;
        }
        
        // Simulate payment processing
        showLoader();
        setTimeout(() => {
          hideLoader();
          showToast('Payment successful! Ticket purchased.', 'success');
          const newPoints = (userData.points || 0) - pointsToUse + 5; // +5 for purchase
          const history = userData.history || [];
          const stops = vehiclesData[busId].stops || [];
          const fromStop = stops[fromIndex]?.name || `Stop ${fromIndex + 1}`;
          const toStop = stops[toIndex]?.name || `Stop ${toIndex + 1}`;
          
          history.push({ 
            type: 'Ticket Purchase', 
            details: `From ${fromStop} to ${toStop} on bus ${busId}`, 
            amount: finalFare,
            passengers: passengerCount,
            timestamp: Date.now() 
          });
          
          // Add points history
          if (pointsToUse > 0) {
            history.push({
              type: 'Points',
              details: 'Points used for ticket discount',
              points: -pointsToUse,
              timestamp: Date.now()
            });
          }
          
          // Add points for purchase
          history.push({
            type: 'Points',
            details: 'Points earned from ticket purchase',
            points: 5,
            timestamp: Date.now()
          });
          
          db.ref(`users/${currentUser.uid}`).update({ 
            points: newPoints, 
            history 
          });
          bootstrap.Modal.getInstance(document.getElementById('buyTicketModal')).hide();
        }, 2000);
      };

      // Safety Button
      const sendSafetyAlert = () => {
        if (!currentUser || !userLocation) {
          showToast('Please login and enable location.', 'warning');
          return;
        }
        
        // Show confirmation modal
        new bootstrap.Modal(document.getElementById('safetyModal')).show();
      };

      const confirmSafetyAlert = () => {
        // Send alert to police and emergency contacts
        showToast('Safety alert sent to nearest police and emergency contacts.', 'danger');
        
        // Record in user history
        const history = userData.history || [];
        history.push({ 
          type: 'Safety Alert', 
          details: 'Emergency alert sent to authorities and contacts', 
          timestamp: Date.now() 
        });
        
        if (currentUser) {
          db.ref(`users/${currentUser.uid}`).update({ history });
        }
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('safetyModal')).hide();
      };

      // Chat Functions
      const updateChatBusSelect = () => {
        dom.chatBusSelect.innerHTML = '<option value="">Select Bus to Chat</option>';
        Object.keys(vehiclesData).forEach(vid => {
          const option = document.createElement('option');
          option.value = vid;
          option.textContent = `${vid} - ${vehiclesData[vid].routeName || 'Unknown'}`;
          dom.chatBusSelect.appendChild(option);
        });
      };

      const startChat = (busId) => {
        if (currentChatBus) {
          db.ref(`chats/${currentChatBus}`).off();
        }
        currentChatBus = busId;
        dom.chatMessages.innerHTML = '';
        db.ref(`chats/${busId}`).on('child_added', snap => {
          const msg = snap.val();
          const div = document.createElement('div');
          div.textContent = `${msg.user}: ${msg.text}`;
          dom.chatMessages.appendChild(div);
          dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight;
        });
      };

      const sendChat = () => {
        if (!currentUser || !currentChatBus) {
          showToast('Select a bus and login to chat.', 'warning');
          return;
        }
        // Check if user is near bus
        const busCoords = parseGps(vehiclesData[currentChatBus].gps);
        if (!busCoords || calculateDistance(userLocation[0], userLocation[1], busCoords[0], busCoords[1]) > 0.5) {
          showToast('You must be near the bus to chat.', 'warning');
          return;
        }
        const text = dom.chatInput.value.trim();
        if (text) {
          db.ref(`chats/${currentChatBus}`).push({
            user: name,
            text,
            timestamp: Date.now()
          });
          dom.chatInput.value = '';
          // Award points
          const newPoints = (userData.points || 0) + 0.5;
          const history = userData.history || [];
          history.push({
            type: 'Points',
            details: 'Points earned from chat activity',
            points: 0.5,
            timestamp: Date.now()
          });
          db.ref(`users/${currentUser.uid}`).update({ 
            points: newPoints,
            history
          });
        }
      };

      // Data & Business Logic
      const loadPublicVehicles = () => {
        const vehiclesRef = db.ref('public_transport/vehicles');
        vehiclesRef.on('value', async snap => {
          hideLoader();
          vehiclesData = snap.val() || {};
          const presentVehicleIds = new Set();
          const bounds = [];

          // Add new & update existing markers
          Object.entries(vehiclesData).forEach(([vid, v]) => {
            presentVehicleIds.add(vid);
            const newCoords = parseGps(v.gps);
            if (newCoords) {
              bounds.push(newCoords);
              if (!markers[vid]) {
                const iconColor = busAlerts[vid] ? '#f59e0b' : '#2563eb';
                const marker = L.marker(newCoords, { icon: createBusIcon(iconColor), title: vid }).addTo(markerGroup);
                marker.bindPopup(`
                  <strong>${vid}</strong><br>
                  ${v.vehicleType || 'Unknown'}<br>
                  ${v.routeName ? `Route: ${v.routeName}` : ''}<br>
                  <span class="text-success"><i class="bi bi-clock"></i> ETA: Calculating...</span>
                  ${busAlerts[vid] ? '<div class="alert-badge">Alert Set</div>' : ''}
                `);
                marker.on('click', () => showVehicleDetails(vid, v));
                markers[vid] = {
                  marker,
                  prevCoords: newCoords,
                  prevTime: v.lastUpdated || Date.now()
                };
              } else {
                const { marker } = markers[vid];
                marker.setLatLng(newCoords);

                // Update icon based on alert status
                const iconColor = busAlerts[vid] ? '#f59e0b' : '#2563eb';
                marker.setIcon(createBusIcon(iconColor));

                marker.setPopupContent(`
                  <strong>${vid}</strong><br>
                  ${v.vehicleType || 'Unknown'}<br>
                  ${v.routeName ? `Route: ${v.routeName}` : ''}<br>
                  <span class="text-success"><i class="bi bi-clock"></i> ETA: Calculating...</span>
                  ${busAlerts[vid] ? '<div class="alert-badge">Alert Set</div>' : ''}
                `);
                markers[vid].prevCoords = newCoords;
                markers[vid].prevTime = v.lastUpdated || Date.now();
              }
            }
          });

          // Remove markers for vehicles no longer present
          Object.keys(markers).forEach(vid => {
            if (!presentVehicleIds.has(vid)) {
              try {
                markerGroup.removeLayer(markers[vid].marker);
              } catch (e) { /* ignore */ }
              delete markers[vid];
            }
          });

          // Fit map to bounds if helpful
          if (bounds.length && map && map.getZoom && map.getZoom() <= 12) {
            try {
              map.flyToBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            } catch (e) {
              console.error("Error fitting bounds:", e);
            }
          }

          // Update dropdowns with current vehicles
          updateBusAlertDropdown();
          updateTicketBusSelect();
          updateChatBusSelect();

          // Update ETAs asynchronously (do not block UI)
          (async () => {
            for (const vid of presentVehicleIds) {
              try {
                if (!markers[vid]) continue;
                const { marker, prevCoords, prevTime } = markers[vid];
                const v = vehiclesData[vid];
                const etaInfo = await getETA(v, prevCoords, prevTime);
                const status = etaInfo.speed > 5 ? 'Moving' : 'Stopped';
                if (marker && marker.setPopupContent) {
                  marker.setPopupContent(`
                    <strong>${vid}</strong><br>
                    ${v.vehicleType || 'Unknown'}<br>
                    ${v.routeName ? `Route: ${v.routeName}` : ''}<br>
                    Status: ${status}<br>
                    <span class="text-success"><i class="bi bi-clock"></i> ETA: ${etaInfo.eta}</span>
                    ${busAlerts[vid] ? '<div class="alert-badge">Alert Set</div>' : ''}
                  `);
                }
              } catch (e) {
                console.error('ETA update error for', vid, e);
              }
            }
          })();

        }, err => {
          console.error('Vehicles listener error:', err);
          showToast('Failed to load vehicles.', 'danger');
          hideLoader();
        });
      };

      const loadBusStops = () => {
        const stopsRef = db.ref('public_transport/stops');
        stopsRef.once('value', snap => {
          const stops = snap.val() || {};
          busStops = Object.entries(stops).map(([id, stop]) => ({
            id,
            name: stop.name,
            gps: stop.gps,
            vehicles: stop.vehicles || []
          }));
          busStops.forEach(stop => {
            const coords = parseGps(stop.gps);
            if (coords) {
              const marker = L.marker(coords, { icon: stopIcon }).addTo(map);
              marker.bindPopup(`
                <strong>${stop.name}</strong><br>
                <small>Click for more info</small>
              `);
              marker.on('click', () => showBusStopPanel(stop));
              stopMarkers[stop.id] = marker;
            }
          });
          if (userLocation) {
            findNearestBusStops();
          }
        }, err => {
          console.error('Bus stops listener error:', err);
          showToast('Failed to load bus stops.', 'danger');
        });
      };

      const searchByVehicleNumber = () => {
        const query = dom.searchVehicleInput ? dom.searchVehicleInput.value.trim().toUpperCase() : '';
        if (!query) {
          showToast('Please enter a vehicle number.', 'warning');
          return;
        }
        // try to find in local vehiclesData
        const foundVid = Object.keys(vehiclesData).find(vid => vid.toUpperCase().includes(query));
        if (foundVid) {
          if (markers[foundVid]) {
            const { marker } = markers[foundVid];
            map.flyTo(marker.getLatLng(), 16);
            marker.openPopup();
            showVehicleDetails(foundVid, vehiclesData[foundVid]);
          } else {
            const coords = parseGps(vehiclesData[foundVid].gps);
            if (coords) {
              map.flyTo(coords, 16);
              showVehicleDetails(foundVid, vehiclesData[foundVid]);
            } else {
              showToast('Vehicle has no valid location.', 'warning');
            }
          }
        } else {
          showToast('Vehicle not found.', 'warning');
        }
      };

      const searchByRoute = async () => {
        const from = dom.searchRouteFrom ? dom.searchRouteFrom.value.trim().toLowerCase() : '';
        const to = dom.searchRouteTo ? dom.searchRouteTo.value.trim().toLowerCase() : '';
        if (!from || !to) {
          showToast('Enter both "From" and "To" locations.', 'warning');
          return;
        }
        dom.searchResults.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm text-primary me-2"></div> Searching...</div>';
        const results = [];
        Object.entries(vehiclesData).forEach(([vid, v]) => {
          const stops = (v.stops || []).map(s => s.name ? s.name.toLowerCase() : '');
          const hasFrom = stops.some(s => s.includes(from));
          const hasTo = stops.some(s => s.includes(to));
          if (hasFrom && hasTo) {
            results.push({ vid, vehicle: v });
          }
        });
        dom.searchResults.innerHTML = '';
        if (results.length > 0) {
          for (const { vid, vehicle } of results) {
            let etaInfo = { eta: 'Calculating...', nextStop: 'N/A' };
            if (markers[vid]) {
              const { prevCoords, prevTime } = markers[vid];
              etaInfo = await getETA(vehicle, prevCoords, prevTime);
            }

            const div = document.createElement('div');
            div.className = 'vehicle-item p-3 border-bottom';
            div.innerHTML = `
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-center">
                  <i class="bi bi-bus-front text-primary me-2"></i>
                  <div>
                    <strong>${vid}</strong> - ${vehicle.routeName || 'N/A'}<br>
                    <small class="text-muted">${vehicle.vehicleType || 'Unknown'}</small>
                  </div>
                </div>
                <span class="eta-badge">${etaInfo.eta}</span>
              </div>
            `;
            div.addEventListener('click', () => {
              if (markers[vid]) {
                const { marker } = markers[vid];
                map.flyTo(marker.getLatLng(), 16);
                marker.openPopup();
                showVehicleDetails(vid, vehicle);
              } else {
                const coords = parseGps(vehicle.gps);
                if (coords) {
                  map.flyTo(coords, 16);
                  showVehicleDetails(vid, vehicle);
                } else {
                  showToast('Vehicle location not available.', 'warning');
                }
              }
            });
            dom.searchResults.appendChild(div);
          }
        } else {
          dom.searchResults.innerHTML = '<div class="text-muted p-3 text-center"><i class="bi bi-exclamation-circle"></i> No routes found.</div>';
        }
      };

      // Event Listeners
      const addEventListeners = () => {
        if (dom.flashScreen) setTimeout(() => dom.flashScreen.classList.add('hidden'), 2000);
        if (dom.locateBtn) dom.locateBtn.addEventListener('click', locateUser);
        if (dom.showBusStopsBtn) dom.showBusStopsBtn.addEventListener('click', () => {
          if (userLocation) {
            findNearestBusStops();
          } else {
            showToast("Please enable location services first.", "warning");
            locateUser();
          }
        });
        if (dom.searchVehicleBtn) dom.searchVehicleBtn.addEventListener('click', searchByVehicleNumber);
        if (dom.searchRouteBtn) dom.searchRouteBtn.addEventListener('click', searchByRoute);
        if (dom.closeSidebarBtn) dom.closeSidebarBtn.addEventListener('click', hideVehicleDetails);
        if (dom.closeBusStopPanelBtn) dom.closeBusStopPanelBtn.addEventListener('click', hideBusStopPanel);
        if (dom.searchVehicleInput) dom.searchVehicleInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchByVehicleNumber(); });
        if (dom.searchRouteFrom) dom.searchRouteFrom.addEventListener('keypress', e => { if (e.key === 'Enter') searchByRoute(); });
        if (dom.searchRouteTo) dom.searchRouteTo.addEventListener('keypress', e => { if (e.key === 'Enter') searchByRoute(); });

        // Auth
        if (dom.loginBtn) dom.loginBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('loginModal')).show());
        if (dom.logoutBtn) dom.logoutBtn.addEventListener('click', logout);
        if (dom.editProfileBtn) dom.editProfileBtn.addEventListener('click', showEditProfile);
        if (dom.saveProfileBtn) dom.saveProfileBtn.addEventListener('click', saveProfile);
        if (dom.historyBtn) dom.historyBtn.addEventListener('click', showHistory);

        // Alerts and lost bag
        if (dom.setAlertBtn) dom.setAlertBtn.addEventListener('click', setBusAlert);
        if (dom.reportLostBagBtn) dom.reportLostBagBtn.addEventListener('click', reportLostBag);

        // Ticket
        if (dom.payTicketBtn) dom.payTicketBtn.addEventListener('click', buyTicket);
        if (dom.usePoints) dom.usePoints.addEventListener('input', calculateTicketFare);
        if (dom.ticketBusSelect) dom.ticketBusSelect.addEventListener('change', (e) => {
          updateTicketStops(e.target.value);
        });
        if (dom.ticketFrom) dom.ticketFrom.addEventListener('change', calculateTicketFare);
        if (dom.ticketTo) dom.ticketTo.addEventListener('change', calculateTicketFare);
        if (dom.passengerCount) dom.passengerCount.addEventListener('change', calculateTicketFare);

        // Safety
        if (dom.safetyBtn) dom.safetyBtn.addEventListener('click', sendSafetyAlert);
        if (dom.confirmSafetyAlertBtn) dom.confirmSafetyAlertBtn.addEventListener('click', confirmSafetyAlert);

        // Language
        if (dom.languageSelect) dom.languageSelect.addEventListener('change', (e) => {
          currentLang = e.target.value;
          updateLanguage();
        });

        // Points
        if (dom.dailyCheckInBtn) dom.dailyCheckInBtn.addEventListener('click', dailyCheckIn);

        // Chat
        if (dom.chatBusSelect) dom.chatBusSelect.addEventListener('change', (e) => startChat(e.target.value));
        if (dom.sendChatBtn) dom.sendChatBtn.addEventListener('click', sendChat);
        if (dom.chatInput) dom.chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendChat();
        });
      };

      // Initialization
      document.addEventListener('DOMContentLoaded', () => {
        showLoader();

        // Load any saved bus alerts
        const savedAlerts = localStorage.getItem('busAlerts');
        if (savedAlerts) {
          try { busAlerts = JSON.parse(savedAlerts); } catch (e) { busAlerts = {}; }
        }

        auth.onAuthStateChanged(handleAuthState);

        initMap();
        loadPublicVehicles();
        loadBusStops();
        addEventListeners();

        // Start checking for bus alerts
        alertCheckInterval = setInterval(checkBusAlerts, 10000); // Check every 10 seconds

        // initial locate, but don't block if fails
        locateUser().catch(() => {
          console.log("Initial geolocation attempt failed; user can manually trigger location.");
          hideLoader();
        });
      });
    })();
  </script>
</body>
  </html>
