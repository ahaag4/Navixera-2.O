<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conductor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
    }
    
    body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    .navbar {
      background: var(--card-bg);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .status-btn {
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .status-btn:hover {
      transform: translateY(-2px);
    }
    
    .location-control {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
      border-radius: 12px;
    }
    
    .notification-item {
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    
    .notification-item:hover {
      background-color: #f1f5f9;
    }
    
    .ticket-item {
      border-left: 4px solid var(--success-color);
    }
    
    .ticket-valid {
      border-left-color: var(--success-color);
    }
    
    .ticket-invalid {
      border-left-color: var(--danger-color);
    }
    
    .location-updating {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .bus-info-card {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center fw-bold text-primary" href="#">
        <i class="bi bi-bus-front me-2 fs-4"></i>
        Conductor Dashboard
      </a>
      <div class="d-flex align-items-center">
        <span id="currentTime" class="text-muted me-3"></span>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-2"></i>
            <span id="conductorName">Loading...</span>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="logoutConductor()">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-4">
    <!-- Bus Information -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bus-info-card p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="fw-bold mb-1" id="busTitle">Loading Bus Details...</h2>
              <p class="mb-2 opacity-75" id="routeName">Fetching route information...</p>
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <span class="badge bg-light text-dark" id="currentStatus">Unknown</span>
                </div>
                <div class="me-3">
                  <small><i class="bi bi-people-fill me-1"></i> <span id="passengerCount">-</span>/<span id="busCapacity">-</span> capacity</small>
                </div>
                <div>
                  <small><i class="bi bi-building me-1"></i> <span id="companyName">Loading...</span></small>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-md-end">
              <h4 class="mb-1" id="currentTimeDisplay">--:-- --</h4>
              <p class="mb-0 opacity-75">Last Update: <span id="lastUpdateTime">--:--</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Control -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card location-control p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h4 class="mb-2 text-white"><i class="bi bi-geo-alt-fill me-2"></i>Location Tracking</h4>
              <p class="mb-0 text-white-50" id="locationStatusText">Click Start to begin automatic location tracking</p>
            </div>
            <div class="col-md-4 text-md-end">
              <button class="btn btn-light btn-lg me-2" id="startLocationBtn" onclick="startLocationTracking()">
                <i class="bi bi-play-circle me-2"></i>Start Tracking
              </button>
              <button class="btn btn-outline-light btn-lg" id="stopLocationBtn" onclick="stopLocationTracking()" disabled>
                <i class="bi bi-stop-circle me-2"></i>Stop Tracking
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Left Column - Status & Location -->
      <div class="col-lg-6">
        <!-- Status Controls -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-speedometer2 me-2 text-primary"></i>Update Bus Status</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <button class="btn btn-success w-100 status-btn" onclick="updateStatus('On Time')">
                <i class="bi bi-check-circle-fill me-2"></i>On Time
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-warning w-100 status-btn" onclick="updateStatus('Delayed')">
                <i class="bi bi-clock-history me-2"></i>Delayed
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-danger w-100 status-btn" onclick="updateStatus('Crowded')">
                <i class="bi bi-people-fill me-2"></i>Crowded
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-secondary w-100 status-btn" onclick="updateStatus('Out of Service')">
                <i class="bi bi-x-circle me-2"></i>Out of Service
              </button>
            </div>
          </div>
        </div>

        <!-- Location Information -->
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-geo me-2 text-primary"></i>Live Location Data</h5>
            <span class="badge bg-success fs-6" id="locationStatusBadge">Ready</span>
          </div>
          
          <div class="location-info p-3 rounded mb-3" style="background-color: #f0f9ff; border-left: 4px solid var(--primary-color);">
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-2">GPS Coordinates</h6>
                <p class="mb-1 fs-5" id="locationCoordinates">Waiting for GPS...</p>
                <small class="text-muted" id="locationAddress">Location services not active</small>
              </div>
              <div class="col-md-6 text-md-end">
                <h6 class="text-primary mb-2">Tracking Info</h6>
                <p class="mb-1">Updates Sent: <span id="locationUpdateCount" class="fw-bold">0</span></p>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="refreshLocation()">
                  <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Map Display -->
          <div class="map-display rounded mb-3" style="height: 200px; background: linear-gradient(135deg, #e2e8f0, #cbd5e1); display: flex; align-items: center; justify-content: center; color: #64748b;">
            <div class="text-center">
              <i class="bi bi-geo-alt-fill display-4 mb-3"></i>
              <p class="mb-1">Live Location Tracking</p>
              <small id="mapStatus">Location will appear here when tracking starts</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Notifications & Tickets -->
      <div class="col-lg-6">
        <!-- Ticket Checking Section -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-ticket-perforated me-2 text-primary"></i>Ticket Verification</h5>
          
          <div class="mb-3">
            <label for="ticketInput" class="form-label">Enter Ticket ID or Scan QR Code</label>
            <div class="input-group">
              <input type="text" class="form-control" id="ticketInput" placeholder="TKT-123456 or scan QR code">
              <button class="btn btn-primary" onclick="verifyTicket()">
                <i class="bi bi-check-circle me-1"></i>Verify
              </button>
            </div>
          </div>

          <div id="ticketResult" class="d-none">
            <!-- Ticket result will be shown here -->
          </div>

          <div class="mt-3">
            <h6>Recent Ticket Checks</h6>
            <div id="recentTickets" style="max-height: 200px; overflow-y: auto;">
              <div class="text-center py-3 text-muted">
                <i class="bi bi-ticket-perforated display-6 mb-2"></i>
                <p>No recent ticket checks</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-bell me-2 text-primary"></i>Notifications</h5>
            <span class="badge bg-primary fs-6" id="notificationCount">0</span>
          </div>
          <div id="notificationsList" style="max-height: 300px; overflow-y: auto;">
            <div class="text-center py-4 text-muted">
              <i class="bi bi-bell display-4 mb-3"></i>
              <p>No notifications</p>
              <small>Notifications from passengers will appear here</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Audio for notifications -->
  <audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let busId = null;
    let conductorData = null;
    let lastNotifKeys = new Set();
    let locationWatchId = null;
    let isTracking = false;
    let locationUpdateCount = 0;
    let recentTicketChecks = [];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      updateTime();
      setInterval(updateTime, 1000);
      
      // Auto-login and fetch conductor data
      initializeConductor();
    });

    // Update current time
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      document.getElementById('currentTimeDisplay').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Initialize conductor session and fetch data
    function initializeConductor() {
      // Get the current authenticated user
      auth.onAuthStateChanged(user => {
        if (user) {
          // Fetch conductor data from database using UID
          db.ref('conductors/' + user.uid).once('value')
            .then(snapshot => {
              conductorData = snapshot.val();
              if (conductorData && conductorData.busId) {
                busId = conductorData.busId;
                document.getElementById('conductorName').textContent = conductorData.name || 'Conductor';
                loadBusData();
                loadNotifications();
              } else {
                showToast('No bus assigned to this conductor', 'warning');
                document.getElementById('conductorName').textContent = 'No Bus Assigned';
                document.getElementById('busTitle').textContent = 'No Bus Assigned';
                document.getElementById('routeName').textContent = 'Please contact administrator';
              }
            })
            .catch(error => {
              console.error('Error fetching conductor data:', error);
              showToast('Error loading conductor data', 'danger');
            });
        } else {
          // Auto-signin anonymously for demo purposes
          auth.signInAnonymously()
            .then((userCredential) => {
              // For demo, try to get bus ID from URL parameter or use a default
              const urlParams = new URLSearchParams(window.location.search);
              busId = urlParams.get('busId') || 'C-306';
              
              // Try to load bus data
              loadBusData();
              loadNotifications();
              showToast('Demo session started', 'info');
            })
            .catch(error => {
              console.error('Auto-login error:', error);
              showToast('Login required', 'danger');
            });
        }
      });
    }

    // Load bus data from database
    function loadBusData() {
      if (!busId) {
        showToast('No bus ID available', 'warning');
        return;
      }

      db.ref("public_transport/vehicles/" + busId).on('value', snapshot => {
        const busData = snapshot.val();
        
        if (busData) {
          // Update bus information with actual data from database
          document.getElementById('busTitle').textContent = `Bus: ${busId}`;
          document.getElementById('routeName').textContent = busData.routeName || 'Route not specified';
          document.getElementById('currentStatus').textContent = busData.status || 'Not Set';
          document.getElementById('passengerCount').textContent = busData.currentPassengers || '0';
          document.getElementById('busCapacity').textContent = busData.capacity || '0';
          document.getElementById('companyName').textContent = busData.companyName || 'Not specified';
          
          if (busData.lastUpdated) {
            const lastUpdate = new Date(busData.lastUpdated);
            document.getElementById('lastUpdateTime').textContent = lastUpdate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          }
        } else {
          // Show message if no bus data found
          document.getElementById('busTitle').textContent = `Bus: ${busId}`;
          document.getElementById('routeName').textContent = 'No bus data found in database';
          document.getElementById('currentStatus').textContent = 'Unknown';
          document.getElementById('passengerCount').textContent = '-';
          document.getElementById('busCapacity').textContent = '-';
          document.getElementById('companyName').textContent = 'Not found';
          showToast('Bus data not found in database', 'warning');
        }
      }, error => {
        console.error('Error loading bus data:', error);
        showToast('Error loading bus data', 'danger');
      });
    }

    // Start automatic location tracking
    function startLocationTracking() {
      if (!busId) {
        showToast('No bus assigned. Cannot track location.', 'warning');
        return;
      }

      if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', 'danger');
        return;
      }
      
      if (isTracking) {
        showToast('Location tracking is already active', 'info');
        return;
      }
      
      // Update UI
      document.getElementById('startLocationBtn').disabled = true;
      document.getElementById('stopLocationBtn').disabled = false;
      document.getElementById('locationStatusText').textContent = 'Automatic location tracking active';
      document.getElementById('locationStatusBadge').textContent = 'Tracking';
      document.getElementById('locationStatusBadge').className = 'badge bg-warning fs-6';
      document.getElementById('mapStatus').textContent = 'Tracking location in real-time...';
      
      showToast('Starting automatic location tracking...', 'info');
      
      // Start watching position
      locationWatchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          locationUpdateCount++;
          
          // Update UI
          document.getElementById('locationCoordinates').textContent = 
            `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          document.getElementById('locationStatusBadge').textContent = 'Active';
          document.getElementById('locationStatusBadge').className = 'badge bg-success fs-6';
          document.getElementById('locationUpdateCount').textContent = locationUpdateCount;
          document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          
          // Get approximate address
          getAddressFromCoords(latitude, longitude);
          
          // Update bus location in Firebase
          updateBusLocation(latitude, longitude);
        },
        error => {
          console.error('Location error:', error);
          let errorMessage = 'Unknown location error';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'Location access denied by user';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'Location information unavailable';
              break;
            case error.TIMEOUT:
              errorMessage = 'Location request timed out';
              break;
          }
          
          document.getElementById('locationStatusBadge').textContent = 'Error';
          document.getElementById('locationStatusBadge').className = 'badge bg-danger fs-6';
          document.getElementById('mapStatus').textContent = errorMessage;
          
          showToast(errorMessage, 'danger');
        },
        { 
          enableHighAccuracy: true,
          maximumAge: 3000,
          timeout: 10000
        }
      );
      
      isTracking = true;
      showToast('Automatic location tracking started', 'success');
    }

    // Stop location tracking
    function stopLocationTracking() {
      if (!isTracking) {
        showToast('Location tracking is not active', 'info');
        return;
      }
      
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
      }
      
      // Update UI
      document.getElementById('startLocationBtn').disabled = false;
      document.getElementById('stopLocationBtn').disabled = true;
      document.getElementById('locationStatusText').textContent = 'Location tracking stopped';
      document.getElementById('locationStatusBadge').textContent = 'Stopped';
      document.getElementById('locationStatusBadge').className = 'badge bg-secondary fs-6';
      document.getElementById('mapStatus').textContent = 'Location tracking stopped';
      
      isTracking = false;
      showToast('Location tracking stopped', 'info');
    }

    // Update bus location in Firebase
    function updateBusLocation(latitude, longitude) {
      if (!busId) return;
      
      const locationData = {
        gps: `${latitude}, ${longitude}`,
        lastLocationUpdate: Date.now()
      };
      
      db.ref("public_transport/vehicles/" + busId).update(locationData)
        .catch(error => {
          console.error('Error updating location:', error);
          showToast('Error updating location in database', 'danger');
        });
    }

    // Simulate getting address from coordinates
    function getAddressFromCoords(lat, lng) {
      const addresses = [
        "Mumbai Central, Maharashtra",
        "Andheri East, Mumbai",
        "Bandra Kurla Complex, Mumbai",
        "Dadar West, Mumbai",
        "Churchgate, Mumbai"
      ];
      
      const addressIndex = Math.abs(Math.floor(lat * 1000)) % addresses.length;
      const address = addresses[addressIndex];
      
      document.getElementById('locationAddress').textContent = address;
    }

    // Refresh location manually
    function refreshLocation() {
      if (!busId) {
        showToast('No bus assigned', 'warning');
        return;
      }

      if (!navigator.geolocation) {
        showToast('Geolocation not available', 'danger');
        return;
      }
      
      document.getElementById('locationStatusBadge').textContent = 'Updating...';
      document.getElementById('locationStatusBadge').className = 'badge bg-warning fs-6 location-updating';
      
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          document.getElementById('locationCoordinates').textContent = 
            `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          document.getElementById('locationStatusBadge').textContent = 'Active';
          document.getElementById('locationStatusBadge').className = 'badge bg-success fs-6';
          
          getAddressFromCoords(latitude, longitude);
          updateBusLocation(latitude, longitude);
          
          showToast('Location refreshed manually', 'success');
        },
        error => {
          console.error('Location error:', error);
          document.getElementById('locationStatusBadge').textContent = 'Error';
          document.getElementById('locationStatusBadge').className = 'badge bg-danger fs-6';
          showToast('Failed to get location', 'danger');
        }
      );
    }

    // Update bus status
    function updateStatus(status) {
      if (!busId) {
        showToast('No bus assigned. Cannot update status.', 'warning');
        return;
      }
      
      db.ref("public_transport/vehicles/" + busId).update({
        status: status,
        lastUpdated: Date.now()
      }).then(() => {
        showToast(`Status updated to: ${status}`, 'success');
        document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }).catch(error => {
        console.error('Error updating status:', error);
        showToast('Error updating status', 'danger');
      });
    }

    // Verify ticket
    function verifyTicket() {
      const ticketInput = document.getElementById('ticketInput').value.trim();
      
      if (!ticketInput) {
        showToast('Please enter a ticket ID', 'warning');
        return;
      }
      
      // Show loading state
      const ticketResult = document.getElementById('ticketResult');
      ticketResult.className = 'ticket-item p-3 rounded mb-3';
      ticketResult.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary mb-2"></div>
          <p>Verifying ticket...</p>
        </div>
      `;
      ticketResult.classList.remove('d-none');
      
      // Query database for ticket verification
      db.ref("tickets/" + ticketInput).once('value')
        .then(snapshot => {
          const ticketData = snapshot.val();
          
          if (ticketData) {
            // Ticket found in database
            const isValid = ticketData.status === 'active' && 
                           ticketData.validUntil > Date.now() &&
                           ticketData.busId === busId;
            
            displayTicketResult({
              ...ticketData,
              id: ticketInput,
              isValid: isValid
            });
            addToRecentTickets({
              ...ticketData,
              id: ticketInput,
              isValid: isValid
            });
          } else {
            // Ticket not found in database
            displayTicketResult({
              id: ticketInput,
              isValid: false,
              passengerName: 'Not Found',
              from: 'N/A',
              to: 'N/A',
              fare: 'N/A',
              validUntil: 'N/A'
            });
            addToRecentTickets({
              id: ticketInput,
              isValid: false,
              timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
          }
          
          // Clear input
          document.getElementById('ticketInput').value = '';
        })
        .catch(error => {
          console.error('Error verifying ticket:', error);
          showToast('Error verifying ticket', 'danger');
          document.getElementById('ticketInput').value = '';
        });
    }

    // Display ticket verification result
    function displayTicketResult(ticketData) {
      const ticketResult = document.getElementById('ticketResult');
      const statusClass = ticketData.isValid ? 'ticket-valid' : 'ticket-invalid';
      const statusIcon = ticketData.isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
      const statusText = ticketData.isValid ? 'VALID TICKET' : 'INVALID TICKET';
      
      ticketResult.className = `ticket-item p-3 rounded mb-3 ${statusClass}`;
      ticketResult.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="mb-0">${statusText}</h5>
          <i class="bi ${statusIcon} fs-4"></i>
        </div>
        ${ticketData.isValid ? `
          <div class="row">
            <div class="col-6">
              <small class="text-muted d-block">Passenger</small>
              <strong>${ticketData.passengerName || 'Unknown'}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Ticket ID</small>
              <strong>${ticketData.id}</strong>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-6">
              <small class="text-muted d-block">Route</small>
              <strong>${ticketData.from || 'N/A'} â†’ ${ticketData.to || 'N/A'}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Fare</small>
              <strong>${ticketData.fare || 'N/A'}</strong>
            </div>
          </div>
          <div class="mt-2">
            <small class="text-muted d-block">Valid Until</small>
            <strong>${ticketData.validUntil ? new Date(ticketData.validUntil).toLocaleTimeString() : 'N/A'}</strong>
          </div>
        ` : `
          <p class="mb-0">This ticket is not valid or has expired.</p>
          <small class="text-muted">Please ask passenger to purchase a valid ticket.</small>
        `}
      `;
    }

    // Add to recent tickets list
    function addToRecentTickets(ticketData) {
      recentTicketChecks.unshift({
        ...ticketData,
        timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
      });
      
      // Keep only last 5 tickets
      if (recentTicketChecks.length > 5) {
        recentTicketChecks = recentTicketChecks.slice(0, 5);
      }
      
      updateRecentTicketsUI();
    }

    // Update recent tickets UI
    function updateRecentTicketsUI() {
      const container = document.getElementById('recentTickets');
      
      if (recentTicketChecks.length === 0) {
        container.innerHTML = `
          <div class="text-center py-3 text-muted">
            <i class="bi bi-ticket-perforated display-6 mb-2"></i>
            <p>No recent ticket checks</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      recentTicketChecks.forEach(ticket => {
        const statusIcon = ticket.isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
        html += `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <i class="bi ${statusIcon} me-2"></i>
              <strong>${ticket.id}</strong>
              <br>
              <small class="text-muted">${ticket.timestamp}</small>
            </div>
            <div class="text-end">
              <small class="${ticket.isValid ? 'text-success' : 'text-danger'} fw-bold">
                ${ticket.isValid ? 'VALID' : 'INVALID'}
              </small>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Load notifications
    function loadNotifications() {
      if (!busId) return;
      
      db.ref("public_transport/vehicles/" + busId + "/notifications")
        .on("value", snapshot => {
          const notifList = document.getElementById("notificationsList");
          const notifCount = document.getElementById("notificationCount");
          
          // Clear existing notifications
          notifList.innerHTML = '';
          
          let count = 0;
          const notifications = [];
          
          snapshot.forEach(child => {
            const key = child.key;
            const notif = child.val();
            notifications.push({ key, notif });
            count++;
          });
          
          // Sort by timestamp (newest first)
          notifications.sort((a, b) => b.notif.timestamp - a.notif.timestamp);
          
          // Display notifications
          if (notifications.length === 0) {
            notifList.innerHTML = `
              <div class="text-center py-4 text-muted">
                <i class="bi bi-bell display-4 mb-3"></i>
                <p>No notifications</p>
                <small>Notifications from passengers will appear here</small>
              </div>
            `;
          } else {
            notifications.forEach(({ key, notif }) => {
              const notifElement = document.createElement('div');
              notifElement.className = 'notification-item p-3 mb-2 rounded';
              
              let iconClass = 'bi-info-circle text-primary';
              if (notif.type === 'lost_bag') {
                iconClass = 'bi-bag-x text-danger';
              } else if (notif.type === 'safety_alert') {
                iconClass = 'bi-shield-exclamation text-warning';
              }
              
              notifElement.innerHTML = `
                <div class="d-flex">
                  <div class="flex-shrink-0">
                    <i class="bi ${iconClass} fs-5"></i>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${notif.type ? notif.type.replace('_', ' ').toUpperCase() : 'Notification'}</h6>
                    <p class="mb-1 small">${notif.description || 'New notification'}</p>
                    <small class="text-muted">${formatTime(notif.timestamp)}</small>
                  </div>
                </div>
              `;
              
              notifList.appendChild(notifElement);
              
              // Play sound only for new notifications
              if (!lastNotifKeys.has(key)) {
                document.getElementById("notifSound").play();
                showToast('New notification received', 'info');
              }
              lastNotifKeys.add(key);
            });
          }
          
          // Update notification count
          notifCount.textContent = count;
        });
    }

    // Format timestamp to relative time
    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      
      const now = Date.now();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
      return `${Math.floor(diff / 86400000)} days ago`;
    }

    // Logout conductor
    function logoutConductor() {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
      }
      
      auth.signOut().then(() => {
        showToast('Logged out successfully', 'info');
        setTimeout(() => {
          alert('Redirecting to login page...');
          // In real app: window.location.reload();
        }, 1000);
      });
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center">
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'danger' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toastContainer.removeChild(toast);
      });
    }

    // Allow Enter key to verify ticket
    document.getElementById('ticketInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyTicket();
      }
    });
  </script>
</body>
  </html>
