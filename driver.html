<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conductor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
    }
    
    body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    .navbar {
      background: var(--card-bg);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .status-btn {
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .status-btn:hover {
      transform: translateY(-2px);
    }
    
    .location-control {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
      border-radius: 12px;
    }
    
    .notification-item {
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    
    .notification-item:hover {
      background-color: #f1f5f9;
    }
    
    .ticket-section {
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
      border-radius: 12px;
    }
    
    .ticket-input {
      background: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    
    .location-updating {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .nav-tabs .nav-link.active {
      border-bottom: 3px solid var(--primary-color);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center fw-bold text-primary" href="#">
        <i class="bi bi-bus-front me-2 fs-4"></i>
        Conductor Dashboard
      </a>
      <div class="d-flex align-items-center">
        <span id="currentTime" class="text-muted me-3"></span>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-2"></i>
            <span id="conductorName">Loading...</span>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="logoutConductor()">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-4">
    <!-- Bus Information -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="fw-bold text-primary mb-2" id="busTitle">Loading Bus Details...</h2>
              <p class="text-muted mb-0" id="routeName">Fetching route information...</p>
            </div>
            <div class="col-md-4 text-md-end">
              <h4 class="mb-1" id="currentTimeDisplay">--:-- --</h4>
              <p class="mb-0 text-muted">Status: <span id="currentStatus" class="badge bg-success">Loading...</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Control -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card location-control p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h4 class="mb-2 text-white"><i class="bi bi-geo-alt-fill me-2"></i>Location Tracking</h4>
              <p class="mb-0 text-white-50" id="locationStatusText">Click Start to begin automatic location tracking</p>
            </div>
            <div class="col-md-4 text-md-end">
              <button class="btn btn-light btn-lg me-2" id="startLocationBtn" onclick="startLocationTracking()">
                <i class="bi bi-play-circle me-2"></i>Start Tracking
              </button>
              <button class="btn btn-outline-light btn-lg" id="stopLocationBtn" onclick="stopLocationTracking()" disabled>
                <i class="bi bi-stop-circle me-2"></i>Stop Tracking
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tickets Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card ticket-section p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h4 class="mb-2 text-white"><i class="bi bi-ticket-perforated me-2"></i>Ticket Verification</h4>
              <p class="mb-0 text-white-50">Enter passenger ticket ID to verify</p>
            </div>
            <div class="col-md-4 text-md-end">
              <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#ticketModal">
                <i class="bi bi-ticket-perforated me-2"></i>Check Ticket
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Left Column - Status & Location -->
      <div class="col-lg-8">
        <!-- Status Controls -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-speedometer2 me-2 text-primary"></i>Update Bus Status</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <button class="btn btn-success w-100 status-btn" onclick="updateStatus('On Time')">
                <i class="bi bi-check-circle-fill me-2"></i>On Time
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-warning w-100 status-btn" onclick="updateStatus('Delayed')">
                <i class="bi bi-clock-history me-2"></i>Delayed
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-danger w-100 status-btn" onclick="updateStatus('Crowded')">
                <i class="bi bi-people-fill me-2"></i>Crowded
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-secondary w-100 status-btn" onclick="updateStatus('Out of Service')">
                <i class="bi bi-x-circle me-2"></i>Out of Service
              </button>
            </div>
          </div>
        </div>

        <!-- Location Information -->
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-geo me-2 text-primary"></i>Live Location Data</h5>
            <span class="badge bg-success fs-6" id="locationStatusBadge">Ready</span>
          </div>
          
          <div class="location-info p-3 rounded mb-3" style="background-color: #f0f9ff; border-left: 4px solid var(--primary-color);">
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-2">GPS Coordinates</h6>
                <p class="mb-1 fs-5" id="locationCoordinates">Waiting for GPS...</p>
                <small class="text-muted" id="locationAddress">Location services not active</small>
              </div>
              <div class="col-md-6 text-md-end">
                <h6 class="text-primary mb-2">Tracking Info</h6>
                <p class="mb-1">Updates Sent: <span id="locationUpdateCount" class="fw-bold">0</span></p>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="refreshLocation()">
                  <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Map Display -->
          <div class="map-display rounded mb-3" style="height: 200px; background: linear-gradient(135deg, #e2e8f0, #cbd5e1); display: flex; align-items: center; justify-content: center; color: #64748b;">
            <div class="text-center">
              <i class="bi bi-geo-alt-fill display-4 mb-3"></i>
              <p class="mb-1">Live Location Tracking</p>
              <small id="mapStatus">Location will appear here when tracking starts</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Notifications & Stats -->
      <div class="col-lg-4">
        <!-- Notifications -->
        <div class="card p-4 mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-bell me-2 text-primary"></i>Notifications</h5>
            <span class="badge bg-primary fs-6" id="notificationCount">0</span>
          </div>
          <div id="notificationsList" style="max-height: 300px; overflow-y: auto;">
            <div class="text-center py-4 text-muted">
              <i class="bi bi-bell display-6 mb-3"></i>
              <p>No notifications</p>
              <small>Notifications from passengers will appear here</small>
            </div>
          </div>
        </div>

        <!-- Today's Stats -->
        <div class="card p-4">
          <h5 class="mb-3"><i class="bi bi-graph-up me-2 text-primary"></i>Today's Stats</h5>
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="fs-2 fw-bold text-primary" id="ticketsChecked">0</div>
              <small class="text-muted">Tickets Checked</small>
            </div>
            <div class="col-6 mb-3">
              <div class="fs-2 fw-bold text-success" id="revenue">₹0</div>
              <small class="text-muted">Revenue</small>
            </div>
          </div>
          <div class="mt-3">
            <div class="progress mb-2">
              <div class="progress-bar" role="progressbar" style="width: 75%" id="routeProgress"></div>
            </div>
            <small class="text-muted">Route Completion: <span id="routeCompletion">75%</span></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket Verification Modal -->
  <div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-ticket-perforated me-2"></i>Verify Ticket</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="ticket-input mb-3">
                <h6 class="mb-3">Enter Ticket ID</h6>
                <form id="ticketForm" onsubmit="verifyTicketById(event)">
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" id="ticketIdInput" placeholder="Enter Ticket ID (e.g., TKT-123456)" required>
                    <button class="btn btn-primary" type="submit">
                      <i class="bi bi-search me-2"></i>Verify Ticket
                    </button>
                  </div>
                </form>
                <small class="text-muted">Enter the ticket ID provided by the passenger to verify their ticket.</small>
              </div>
            </div>
            <div class="col-md-6">
              <div id="ticketResult">
                <div class="text-center py-4 text-muted">
                  <i class="bi bi-ticket-perforated display-4 mb-3"></i>
                  <p>Enter a Ticket ID to verify</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Audio for notifications -->
  <audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let busId = null;
    let conductorData = null;
    let lastNotifKeys = new Set();
    let locationWatchId = null;
    let isTracking = false;
    let locationUpdateCount = 0;
    let ticketsChecked = 0;
    let totalRevenue = 0;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      updateTime();
      setInterval(updateTime, 1000);
      
      // Auto-login and fetch conductor data
      initializeConductor();
    });

    // Update current time
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      document.getElementById('currentTimeDisplay').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Initialize conductor session
    function initializeConductor() {
      const urlParams = new URLSearchParams(window.location.search);
      const conductorEmail = urlParams.get('email') || localStorage.getItem('conductorEmail');
      
      if (conductorEmail) {
        busId = conductorEmail.split('@')[0].toUpperCase();
        fetchConductorData();
      } else {
        busId = "C-306";
        conductorData = {
          name: "Rajesh Kumar",
          route: "Central Station ↔ North Park"
        };
        updateUIWithConductorData();
        showToast('Demo mode activated', 'info');
      }
    }

    // Fetch conductor data from Firebase
    function fetchConductorData() {
      db.ref('conductors/' + busId).once('value')
        .then(snapshot => {
          conductorData = snapshot.val();
          if (conductorData) {
            updateUIWithConductorData();
            showToast('Conductor data loaded successfully', 'success');
          } else {
            createConductorData();
          }
        })
        .catch(error => {
          console.error('Error fetching conductor data:', error);
          showToast('Error loading conductor data', 'danger');
        });
    }

    // Create conductor data if not exists
    function createConductorData() {
      conductorData = {
        name: "Conductor " + busId,
        email: busId.toLowerCase() + "@transit.com",
        route: "Route " + busId,
        busId: busId,
        createdAt: Date.now()
      };
      
      db.ref('conductors/' + busId).set(conductorData)
        .then(() => {
          updateUIWithConductorData();
          showToast('New conductor profile created', 'success');
        })
        .catch(error => {
          console.error('Error creating conductor data:', error);
          showToast('Error creating conductor profile', 'danger');
        });
    }

    // Update UI with conductor data
    function updateUIWithConductorData() {
      document.getElementById('conductorName').textContent = conductorData.name;
      document.getElementById('busTitle').textContent = 'Bus: ' + busId;
      document.getElementById('routeName').textContent = conductorData.route;
      
      loadBusData();
      loadNotifications();
      updateStats();
    }

    // Load bus data from Firebase
    function loadBusData() {
      db.ref("public_transport/vehicles/" + busId).on('value', snapshot => {
        const busData = snapshot.val();
        if (busData) {
          if (busData.status) {
            document.getElementById('currentStatus').textContent = busData.status;
            updateStatusBadge(busData.status);
          }
          if (busData.routeName) {
            document.getElementById('routeName').textContent = busData.routeName;
          }
        } else {
          createBusData();
        }
      });
    }

    // Create initial bus data
    function createBusData() {
      const busData = {
        vehicleType: 'Bus',
        routeName: conductorData.route,
        status: 'On Time',
        capacity: 50,
        companyName: 'City Transit',
        lastUpdated: Date.now()
      };
      
      db.ref("public_transport/vehicles/" + busId).set(busData)
        .then(() => {
          showToast('Bus data initialized', 'success');
        })
        .catch(error => {
          console.error('Error creating bus data:', error);
        });
    }

    // Update status badge color
    function updateStatusBadge(status) {
      const badge = document.getElementById('currentStatus');
      badge.textContent = status;
      
      switch(status) {
        case 'On Time':
          badge.className = 'badge bg-success';
          break;
        case 'Delayed':
          badge.className = 'badge bg-warning';
          break;
        case 'Crowded':
          badge.className = 'badge bg-danger';
          break;
        case 'Out of Service':
          badge.className = 'badge bg-secondary';
          break;
        default:
          badge.className = 'badge bg-primary';
      }
    }

    // Start automatic location tracking
    function startLocationTracking() {
      if (!navigator.geolocation) {
        showToast('Geolocation is not supported by your browser', 'danger');
        return;
      }
      
      if (isTracking) {
        showToast('Location tracking is already active', 'info');
        return;
      }
      
      document.getElementById('startLocationBtn').disabled = true;
      document.getElementById('stopLocationBtn').disabled = false;
      document.getElementById('locationStatusText').textContent = 'Automatic location tracking active';
      document.getElementById('locationStatusBadge').textContent = 'Tracking';
      document.getElementById('locationStatusBadge').className = 'badge bg-warning fs-6';
      document.getElementById('mapStatus').textContent = 'Tracking location in real-time...';
      
      showToast('Starting automatic location tracking...', 'info');
      
      locationWatchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          locationUpdateCount++;
          
          document.getElementById('locationCoordinates').textContent = 
            `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          document.getElementById('locationStatusBadge').textContent = 'Active';
          document.getElementById('locationStatusBadge').className = 'badge bg-success fs-6';
          document.getElementById('locationUpdateCount').textContent = locationUpdateCount;
          
          getAddressFromCoords(latitude, longitude);
          updateBusLocation(latitude, longitude);
        },
        error => {
          console.error('Location error:', error);
          handleLocationError(error);
        },
        { 
          enableHighAccuracy: true,
          maximumAge: 3000,
          timeout: 10000
        }
      );
      
      isTracking = true;
      showToast('Automatic location tracking started', 'success');
    }

    // Handle location errors
    function handleLocationError(error) {
      let errorMessage = 'Unknown location error';
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = 'Location access denied by user';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = 'Location information unavailable';
          break;
        case error.TIMEOUT:
          errorMessage = 'Location request timed out';
          break;
      }
      
      document.getElementById('locationStatusBadge').textContent = 'Error';
      document.getElementById('locationStatusBadge').className = 'badge bg-danger fs-6';
      document.getElementById('mapStatus').textContent = errorMessage;
      
      showToast(errorMessage, 'danger');
    }

    // Stop location tracking
    function stopLocationTracking() {
      if (!isTracking) {
        showToast('Location tracking is not active', 'info');
        return;
      }
      
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
      }
      
      document.getElementById('startLocationBtn').disabled = false;
      document.getElementById('stopLocationBtn').disabled = true;
      document.getElementById('locationStatusText').textContent = 'Location tracking stopped';
      document.getElementById('locationStatusBadge').textContent = 'Stopped';
      document.getElementById('locationStatusBadge').className = 'badge bg-secondary fs-6';
      document.getElementById('mapStatus').textContent = 'Location tracking stopped';
      
      isTracking = false;
      showToast('Location tracking stopped', 'info');
    }

    // Update bus location in Firebase
    function updateBusLocation(latitude, longitude) {
      if (!busId) return;
      
      const locationData = {
        gps: `${latitude}, ${longitude}`,
        lastLocationUpdate: Date.now(),
        latitude: latitude,
        longitude: longitude
      };
      
      db.ref("public_transport/vehicles/" + busId).update(locationData)
        .catch(error => {
          console.error('Error updating location:', error);
          showToast('Error updating location in database', 'danger');
        });
    }

    // Simulate getting address from coordinates
    function getAddressFromCoords(lat, lng) {
      const addresses = [
        "Mumbai Central, Maharashtra",
        "Andheri East, Mumbai",
        "Bandra Kurla Complex, Mumbai",
        "Dadar West, Mumbai",
        "Churchgate, Mumbai"
      ];
      
      const addressIndex = Math.abs(Math.floor(lat * 1000)) % addresses.length;
      const address = addresses[addressIndex];
      
      document.getElementById('locationAddress').textContent = address;
    }

    // Refresh location manually
    function refreshLocation() {
      if (!navigator.geolocation) {
        showToast('Geolocation not available', 'danger');
        return;
      }
      
      document.getElementById('locationStatusBadge').textContent = 'Updating...';
      document.getElementById('locationStatusBadge').className = 'badge bg-warning fs-6 location-updating';
      
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          document.getElementById('locationCoordinates').textContent = 
            `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          document.getElementById('locationStatusBadge').textContent = 'Active';
          document.getElementById('locationStatusBadge').className = 'badge bg-success fs-6';
          
          getAddressFromCoords(latitude, longitude);
          updateBusLocation(latitude, longitude);
          
          showToast('Location refreshed manually', 'success');
        },
        error => {
          console.error('Location error:', error);
          document.getElementById('locationStatusBadge').textContent = 'Error';
          document.getElementById('locationStatusBadge').className = 'badge bg-danger fs-6';
          showToast('Failed to get location', 'danger');
        }
      );
    }

    // Update bus status
    function updateStatus(status) {
      if (!busId) return;
      
      db.ref("public_transport/vehicles/" + busId).update({
        status: status,
        lastUpdated: Date.now()
      }).then(() => {
        showToast(`Status updated to: ${status}`, 'success');
        updateStatusBadge(status);
      }).catch(error => {
        console.error('Error updating status:', error);
        showToast('Error updating status', 'danger');
      });
    }

    // Load notifications
    function loadNotifications() {
      if (!busId) return;
      
      db.ref("public_transport/vehicles/" + busId + "/notifications")
        .on("value", snapshot => {
          const notifList = document.getElementById("notificationsList");
          const notifCount = document.getElementById("notificationCount");
          
          notifList.innerHTML = '';
          
          let count = 0;
          const notifications = [];
          
          snapshot.forEach(child => {
            const key = child.key;
            const notif = child.val();
            notifications.push({ key, notif });
            count++;
          });
          
          notifications.sort((a, b) => b.notif.timestamp - a.notif.timestamp);
          
          if (notifications.length === 0) {
            notifList.innerHTML = `
              <div class="text-center py-4 text-muted">
                <i class="bi bi-bell display-6 mb-3"></i>
                <p>No notifications</p>
                <small>Notifications from passengers will appear here</small>
              </div>
            `;
          } else {
            notifications.forEach(({ key, notif }) => {
              const notifElement = document.createElement('div');
              notifElement.className = 'notification-item p-3 mb-2 rounded';
              
              let iconClass = 'bi-info-circle text-primary';
              if (notif.type === 'lost_bag') {
                iconClass = 'bi-bag-x text-danger';
              } else if (notif.type === 'safety_alert') {
                iconClass = 'bi-shield-exclamation text-warning';
              }
              
              notifElement.innerHTML = `
                <div class="d-flex">
                  <div class="flex-shrink-0">
                    <i class="bi ${iconClass} fs-5"></i>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${notif.type ? notif.type.replace('_', ' ').toUpperCase() : 'Notification'}</h6>
                    <p class="mb-1 small">${notif.description || 'New notification'}</p>
                    <small class="text-muted">${formatTime(notif.timestamp)}</small>
                  </div>
                </div>
              `;
              
              notifList.appendChild(notifElement);
              
              if (!lastNotifKeys.has(key)) {
                document.getElementById("notifSound").play();
                showToast('New notification received', 'info');
              }
              lastNotifKeys.add(key);
            });
          }
          
          notifCount.textContent = count;
        });
    }

    // Handle ticket verification form submission
    function verifyTicketById(event) {
      event.preventDefault();
      const ticketId = document.getElementById('ticketIdInput').value.trim().toUpperCase();
      
      if (!ticketId) {
        showToast('Please enter a Ticket ID', 'danger');
        return;
      }

      db.ref('tickets/' + ticketId).once('value')
        .then(snapshot => {
          const ticketData = snapshot.val();
          if (ticketData) {
            verifyTicket(ticketData);
          } else {
            const resultDiv = document.getElementById('ticketResult');
            resultDiv.innerHTML = `
              <div class="alert alert-danger">
                <h5><i class="bi bi-x-circle me-2"></i>Ticket Not Found</h5>
                <p><strong>Ticket ID:</strong> ${ticketId}</p>
                <p class="mb-0"><strong>Status:</strong> NOT FOUND</p>
              </div>
            `;
            showToast('Ticket not found in database', 'danger');
          }
        })
        .catch(error => {
          console.error('Error fetching ticket:', error);
          showToast('Error verifying ticket', 'danger');
        });
    }

    // Verify ticket
    function verifyTicket(ticketData) {
      const resultDiv = document.getElementById('ticketResult');
      const now = Date.now();

      if (!ticketData) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-x-circle me-2"></i>Invalid Ticket</h5>
            <p class="mb-0"><strong>Status:</strong> INVALID</p>
          </div>
        `;
        showToast('Invalid ticket data', 'danger');
        return;
      }

      if (ticketData.validUntil < now) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-x-circle me-2"></i>Ticket Expired</h5>
            <p><strong>Ticket ID:</strong> ${ticketData.ticketId}</p>
            <p><strong>Passenger:</strong> ${ticketData.passengerName || 'Unknown'}</p>
            <p><strong>Route:</strong> ${ticketData.fromStop} → ${ticketData.toStop}</p>
            <p class="mb-0"><strong>Status:</strong> EXPIRED</p>
          </div>
        `;
        showToast('Ticket expired!', 'danger');
      } else if (ticketData.busId !== busId) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Wrong Bus</h5>
            <p><strong>Ticket ID:</strong> ${ticketData.ticketId}</p>
            <p><strong>Passenger:</strong> ${ticketData.passengerName || 'Unknown'}</p>
            <p><strong>Valid for Bus:</strong> ${ticketData.busId}</p>
            <p class="mb-0"><strong>Status:</strong> INVALID FOR THIS BUS</p>
          </div>
        `;
        showToast('Ticket not valid for this bus!', 'warning');
      } else {
        resultDiv.innerHTML = `
          <div class="alert alert-success">
            <h5><i class="bi bi-check-circle me-2"></i>Ticket Valid</h5>
            <p><strong>Ticket ID:</strong> ${ticketData.ticketId}</p>
            <p><strong>Passenger:</strong> ${ticketData.passengerName || 'Unknown'}</p>
            <p><strong>Route:</strong> ${ticketData.fromStop} → ${ticketData.toStop}</p>
            <p><strong>Fare:</strong> ₹${ticketData.fare}</p>
            <p class="mb-0"><strong>Status:</strong> ACTIVE</p>
          </div>
        `;
        showToast('Ticket verified successfully!', 'success');
        
        ticketsChecked++;
        totalRevenue += ticketData.fare || 0;
        updateStats();
      }
    }

    // Update statistics
    function updateStats() {
      document.getElementById('ticketsChecked').textContent = ticketsChecked;
      document.getElementById('revenue').textContent = '₹' + totalRevenue;
      
      const completion = 75; // Placeholder; replace with real data if available
      document.getElementById('routeCompletion').textContent = completion + '%';
      document.getElementById('routeProgress').style.width = completion + '%';
    }

    // Format timestamp to relative time
    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      
      const now = Date.now();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
      return `${Math.floor(diff / 86400000)} days ago`;
    }

    // Logout conductor
    function logoutConductor() {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
      }
      
      showToast('Logged out successfully', 'info');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 1000);
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center">
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'danger' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toastContainer.removeChild(toast);
      });
    }
  </script>
</body>
  </html>
