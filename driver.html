<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conductor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-radius: 12px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-container {
      max-width: 400px;
      width: 100%;
      padding: 2rem;
    }
    
    .dashboard {
      display: none;
      width: 100%;
      height: 100vh;
      overflow: auto;
    }
    
    .navbar {
      background: var(--card-bg);
      box-shadow: var(--shadow-sm);
    }
    
    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .status-btn {
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .status-btn:hover {
      transform: translateY(-2px);
    }
    
    .notification-item {
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    
    .notification-item:hover {
      background-color: #f1f5f9;
    }
    
    .location-status {
      background-color: #f0f9ff;
      border-left: 4px solid var(--primary-color);
    }
    
    .location-updating {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .bus-info-card {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
    }
    
    .stats-card {
      background-color: white;
    }
    
    .stats-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .stats-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .ticket-card {
      background-color: white;
      border-left: 4px solid var(--success-color);
    }
    
    .ticket-count {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--success-color);
    }
    
    .map-container {
      height: 200px;
      border-radius: var(--border-radius);
      overflow: hidden;
      background-color: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }
    
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1055;
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div class="login-container">
    <div class="card shadow-lg">
      <div class="card-body p-5">
        <div class="text-center mb-4">
          <i class="bi bi-bus-front display-4 text-primary mb-3"></i>
          <h2 class="fw-bold">Conductor Login</h2>
          <p class="text-muted">Enter your credentials to access the dashboard</p>
        </div>
        
        <form id="loginForm">
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control form-control-lg" id="email" placeholder="conductor@transit.com" required>
          </div>
          <div class="mb-4">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control form-control-lg" id="password" placeholder="Enter your password" required>
          </div>
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-box-arrow-in-right me-2"></i>Login
          </button>
        </form>
        
        <div class="text-center mt-4">
          <small class="text-muted">Demo: Use any email/password (simulated login)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div class="dashboard" id="dashboard">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <i class="bi bi-bus-front me-2" style="color: var(--primary-color); font-size: 1.5rem;"></i>
          <span class="fw-bold">Conductor Dashboard</span>
        </a>
        <div class="d-flex align-items-center">
          <div class="me-3">
            <span id="currentTime" class="text-muted"></span>
          </div>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle me-1"></i>
              <span id="conductorName">Conductor</span>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="logoutConductor()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
      <!-- Bus Information & Status -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="card bus-info-card p-4">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h2 id="busIdDisplay" class="fw-bold mb-1">Loading...</h2>
                <p id="routeName" class="mb-2">Fetching route...</p>
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <span class="badge bg-light text-dark" id="currentStatus">Unknown</span>
                  </div>
                  <div>
                    <small><i class="bi bi-people-fill me-1"></i> <span id="passengerCount">0</span> passengers</small>
                  </div>
                </div>
              </div>
              <div class="col-md-6 text-md-end">
                <h4 class="mb-1" id="currentTimeDisplay">--:-- --</h4>
                <p class="mb-0">Next Stop: <span id="nextStop">Loading...</span></p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card stats-card h-100 p-3">
            <div class="row text-center">
              <div class="col-6 border-end">
                <div class="stats-value text-primary" id="ticketsSold">0</div>
                <div class="stats-label">Tickets Today</div>
              </div>
              <div class="col-6">
                <div class="stats-value text-success" id="revenue">₹0</div>
                <div class="stats-label">Revenue</div>
              </div>
            </div>
            <div class="mt-3">
              <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted">Route Completion: <span id="routeCompletion">0%</span></small>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Controls -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card p-3">
            <h5 class="mb-3">Update Bus Status</h5>
            <div class="row g-3">
              <div class="col-md-3">
                <button class="btn btn-success w-100 status-btn" onclick="updateStatus('On Time')">
                  <i class="bi bi-check-circle-fill"></i> On Time
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-warning w-100 status-btn" onclick="updateStatus('Delayed')">
                  <i class="bi bi-clock-history"></i> Delayed
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-danger w-100 status-btn" onclick="updateStatus('Crowded')">
                  <i class="bi bi-people-fill"></i> Crowded
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-secondary w-100 status-btn" onclick="updateStatus('Out of Service')">
                  <i class="bi bi-x-circle"></i> Out of Service
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Location & Notifications -->
      <div class="row">
        <!-- Location & Tickets -->
        <div class="col-lg-8 mb-4">
          <div class="card p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5>Location Tracking</h5>
              <div>
                <span class="badge bg-success" id="locationStatus">Active</span>
              </div>
            </div>
            <div class="location-status p-3 rounded mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">GPS Location</h6>
                  <p class="mb-0 text-muted" id="locationCoordinates">Waiting for GPS...</p>
                  <small class="text-muted" id="locationAddress">Getting location...</small>
                </div>
                <div class="text-end">
                  <button class="btn btn-sm btn-outline-primary" onclick="refreshLocation()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                  </button>
                </div>
              </div>
            </div>
            <div class="map-container mb-3">
              <div class="text-center">
                <i class="bi bi-geo-alt-fill display-4 text-primary mb-2"></i>
                <p>Live Location Map</p>
                <small class="text-muted">Using conductor's GPS for bus location</small>
              </div>
            </div>
          </div>

          <!-- Recent Tickets -->
          <div class="card p-3">
            <h5 class="mb-3">Recent Tickets</h5>
            <div id="recentTicketsContainer">
              <div class="text-center py-4 text-muted">
                <i class="bi bi-ticket-perforated display-6 mb-3"></i>
                <p>No tickets recorded yet</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="col-lg-4 mb-4">
          <div class="card p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5>Notifications</h5>
              <span class="badge bg-primary" id="notificationCount">0</span>
            </div>
            <div id="notificationsList" style="max-height: 500px; overflow-y: auto;">
              <div class="text-center py-4 text-muted">
                <i class="bi bi-bell display-6 mb-3"></i>
                <p>No notifications</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Audio for notifications -->
  <audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    let busId = null;
    let conductorData = null;
    let lastNotifKeys = new Set();
    let locationWatchId = null;
    let busDataRef = null;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      updateTime();
      setInterval(updateTime, 1000);
      
      // Setup login form
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loginConductor();
      });
      
      // Check if already logged in (for demo purposes)
      checkExistingSession();
    });

    // Check for existing session
    function checkExistingSession() {
      const savedSession = localStorage.getItem('conductorSession');
      if (savedSession) {
        const session = JSON.parse(savedSession);
        initializeDashboard(session.busId, session.conductorData);
      }
    }

    // Update current time
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      if (document.getElementById('currentTimeDisplay')) {
        document.getElementById('currentTimeDisplay').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
    }

    // Login conductor
    function loginConductor() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      // Show loading state
      const submitBtn = document.querySelector('#loginForm button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> Logging in...';
      submitBtn.disabled = true;
      
      // Simulate login process (in real app, use Firebase Auth)
      setTimeout(() => {
        // Extract bus ID from email (format: busid@company.com)
        const busIdFromEmail = email.split('@')[0].toUpperCase();
        
        // Fetch conductor data from database
        db.ref('conductors/' + busIdFromEmail).once('value')
          .then(snapshot => {
            const conductorData = snapshot.val();
            
            if (conductorData) {
              // Successfully logged in
              initializeDashboard(busIdFromEmail, conductorData);
              
              // Save session
              localStorage.setItem('conductorSession', JSON.stringify({
                busId: busIdFromEmail,
                conductorData: conductorData
              }));
              
              showToast('Login successful!', 'success');
            } else {
              // Conductor not found in database, create demo data
              createDemoConductorData(busIdFromEmail, email);
            }
          })
          .catch(error => {
            console.error('Login error:', error);
            showToast('Login failed. Please try again.', 'danger');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          });
      }, 1500);
    }

    // Create demo conductor data if not exists
    function createDemoConductorData(busId, email) {
      const conductorData = {
        name: email.split('@')[0].toUpperCase() + ' Conductor',
        email: email,
        busId: busId,
        route: 'Central Station ↔ North Park',
        assignedAt: Date.now()
      };
      
      // Save to database
      db.ref('conductors/' + busId).set(conductorData)
        .then(() => {
          // Also create bus data if not exists
          const busData = {
            vehicleType: 'Bus',
            routeName: conductorData.route,
            status: 'On Time',
            capacity: 50,
            companyName: 'City Transit'
          };
          
          return db.ref('public_transport/vehicles/' + busId).set(busData);
        })
        .then(() => {
          initializeDashboard(busId, conductorData);
          
          // Save session
          localStorage.setItem('conductorSession', JSON.stringify({
            busId: busId,
            conductorData: conductorData
          }));
          
          showToast('New conductor account created!', 'success');
        })
        .catch(error => {
          console.error('Error creating demo data:', error);
          showToast('Login failed. Please try again.', 'danger');
          const submitBtn = document.querySelector('#loginForm button[type="submit"]');
          submitBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Login';
          submitBtn.disabled = false;
        });
    }

    // Initialize dashboard after login
    function initializeDashboard(busIdFromLogin, conductorDataFromDB) {
      busId = busIdFromLogin;
      conductorData = conductorDataFromDB;
      
      // Hide login, show dashboard
      document.querySelector('.login-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      
      // Update UI with conductor data
      document.getElementById('conductorName').textContent = conductorData.name || 'Conductor';
      document.getElementById('busIdDisplay').textContent = busId;
      document.getElementById('routeName').textContent = conductorData.route || 'Route not assigned';
      
      // Load bus data from database
      loadBusData();
      
      // Start location tracking
      startLocationTracking();
      
      // Load notifications
      loadNotifications();
      
      // Load tickets data
      loadTicketsData();
    }

    // Load bus data from database
    function loadBusData() {
      busDataRef = db.ref('public_transport/vehicles/' + busId);
      
      busDataRef.on('value', snapshot => {
        const busData = snapshot.val();
        
        if (busData) {
          // Update status
          if (busData.status) {
            document.getElementById('currentStatus').textContent = busData.status;
          }
          
          // Update passenger count (random for demo)
          if (busData.capacity) {
            const passengerCount = Math.floor(Math.random() * busData.capacity);
            document.getElementById('passengerCount').textContent = passengerCount;
          }
          
          // Update route completion (random for demo)
          const completion = Math.floor(Math.random() * 100);
          document.getElementById('routeCompletion').textContent = completion + '%';
          document.querySelector('.progress-bar').style.width = completion + '%';
          
          // Update next stop (from route data)
          if (busData.stops && busData.currentStopIndex !== undefined) {
            const nextStopIndex = (busData.currentStopIndex + 1) % busData.stops.length;
            const nextStop = busData.stops[nextStopIndex];
            document.getElementById('nextStop').textContent = nextStop.name || 'Unknown';
          }
        }
      });
    }

    // Update bus status
    function updateStatus(status) {
      if (!busId) return;
      
      // Update in Firebase
      db.ref("public_transport/vehicles/" + busId).update({
        status: status,
        lastUpdated: Date.now()
      }).then(() => {
        showToast(`Status updated to: ${status}`, 'success');
      });
    }

    // Start tracking conductor's location for bus
    function startLocationTracking() {
      if (!navigator.geolocation) {
        document.getElementById('locationStatus').textContent = 'Unavailable';
        document.getElementById('locationStatus').className = 'badge bg-danger';
        return;
      }
      
      document.getElementById('locationStatus').textContent = 'Tracking...';
      document.getElementById('locationStatus').className = 'badge bg-warning';
      
      locationWatchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          
          // Update UI
          document.getElementById('locationCoordinates').textContent = 
            `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
          document.getElementById('locationStatus').textContent = 'Active';
          document.getElementById('locationStatus').className = 'badge bg-success';
          
          // Update bus location in Firebase
          if (busId) {
            db.ref("public_transport/vehicles/" + busId).update({
              gps: `${latitude}, ${longitude}`,
              lastLocationUpdate: Date.now()
            });
          }
          
          // Get approximate address (simulated)
          getAddressFromCoords(latitude, longitude);
        },
        error => {
          console.error('Location error:', error);
          document.getElementById('locationStatus').textContent = 'Error';
          document.getElementById('locationStatus').className = 'badge bg-danger';
        },
        { 
          enableHighAccuracy: true,
          maximumAge: 10000,
          timeout: 15000
        }
      );
    }

    // Simulate getting address from coordinates
    function getAddressFromCoords(lat, lng) {
      // In a real app, you would use a geocoding service
      const addresses = [
        "Mumbai Central, Maharashtra",
        "Andheri East, Mumbai",
        "Bandra Kurla Complex, Mumbai",
        "Dadar West, Mumbai"
      ];
      
      const randomAddress = addresses[Math.floor(Math.random() * addresses.length)];
      document.getElementById('locationAddress').textContent = randomAddress;
    }

    // Refresh location manually
    function refreshLocation() {
      document.getElementById('locationStatus').textContent = 'Updating...';
      document.getElementById('locationStatus').className = 'badge bg-warning location-updating';
      
      // Force a location update
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            document.getElementById('locationCoordinates').textContent = 
              `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            document.getElementById('locationStatus').textContent = 'Active';
            document.getElementById('locationStatus').className = 'badge bg-success';
            
            // Update bus location
            if (busId) {
              db.ref("public_transport/vehicles/" + busId).update({
                gps: `${latitude}, ${longitude}`,
                lastLocationUpdate: Date.now()
              });
            }
            
            getAddressFromCoords(latitude, longitude);
          },
          error => {
            console.error('Location error:', error);
            document.getElementById('locationStatus').textContent = 'Error';
            document.getElementById('locationStatus').className = 'badge bg-danger';
          }
        );
      }
    }

    // Load notifications from database
    function loadNotifications() {
      if (!busId) return;
      
      db.ref("public_transport/vehicles/" + busId + "/notifications")
        .on("value", snapshot => {
          const notifList = document.getElementById("notificationsList");
          const notifCount = document.getElementById("notificationCount");
          
          // Clear existing notifications
          notifList.innerHTML = '';
          
          let count = 0;
          const notifications = [];
          
          snapshot.forEach(child => {
            const key = child.key;
            const notif = child.val();
            notifications.push({ key, notif });
            count++;
          });
          
          // Sort by timestamp (newest first)
          notifications.sort((a, b) => b.notif.timestamp - a.notif.timestamp);
          
          // Display notifications
          if (notifications.length === 0) {
            notifList.innerHTML = `
              <div class="text-center py-4 text-muted">
                <i class="bi bi-bell display-6 mb-3"></i>
                <p>No notifications</p>
              </div>
            `;
          } else {
            notifications.forEach(({ key, notif }) => {
              const notifElement = document.createElement('div');
              notifElement.className = 'notification-item p-3 mb-2 rounded';
              
              let iconClass = 'bi-info-circle text-primary';
              if (notif.type === 'lost_bag') {
                iconClass = 'bi-bag-x text-danger';
              } else if (notif.type === 'safety_alert') {
                iconClass = 'bi-shield-exclamation text-warning';
              }
              
              notifElement.innerHTML = `
                <div class="d-flex">
                  <div class="flex-shrink-0">
                    <i class="bi ${iconClass}"></i>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${notif.type ? notif.type.replace('_', ' ').toUpperCase() : 'Notification'}</h6>
                    <p class="mb-1 small">${notif.description || 'New notification'}</p>
                    <small class="text-muted">${formatTime(notif.timestamp)}</small>
                  </div>
                </div>
              `;
              
              notifList.appendChild(notifElement);
              
              // Play sound only for new notifications
              if (!lastNotifKeys.has(key)) {
                document.getElementById("notifSound").play();
                showToast('New notification received', 'info');
              }
              lastNotifKeys.add(key);
            });
          }
          
          // Update notification count
          notifCount.textContent = count;
        });
    }

    // Load tickets data from database
    function loadTicketsData() {
      if (!busId) return;
      
      // For demo, we'll generate random ticket data
      // In a real app, you would fetch from database
      const today = new Date();
      const ticketsSold = Math.floor(Math.random() * 50) + 20;
      const revenue = ticketsSold * 25; // Assuming average fare of ₹25
      
      document.getElementById('ticketsSold').textContent = ticketsSold;
      document.getElementById('revenue').textContent = '₹' + revenue;
      
      // Generate recent tickets
      const recentTicketsContainer = document.getElementById('recentTicketsContainer');
      const ticketTemplates = [
        { from: 'Central Station', to: 'City Center', fare: 25 },
        { from: 'City Center', to: 'North Park', fare: 20 },
        { from: 'North Park', to: 'University', fare: 30 },
        { from: 'Central Station', to: 'North Park', fare: 35 }
      ];
      
      let ticketsHTML = '';
      for (let i = 0; i < 5; i++) {
        const ticket = ticketTemplates[Math.floor(Math.random() * ticketTemplates.length)];
        const time = new Date(today.getTime() - Math.random() * 3600000); // Random time in last hour
        const ticketId = 'TKT-' + (8000 + Math.floor(Math.random() * 1000));
        
        ticketsHTML += `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <h6 class="mb-1">${ticketId}</h6>
              <small class="text-muted">${ticket.from} → ${ticket.to}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold">₹${ticket.fare}</div>
              <small class="text-muted">${time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
            </div>
          </div>
        `;
      }
      
      recentTicketsContainer.innerHTML = ticketsHTML;
    }

    // Format timestamp to relative time
    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      
      const now = Date.now();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
      return `${Math.floor(diff / 86400000)} days ago`;
    }

    // Logout conductor
    function logoutConductor() {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
      }
      
      if (busDataRef) {
        busDataRef.off();
      }
      
      // Clear session
      localStorage.removeItem('conductorSession');
      
      // Reset UI
      document.querySelector('.login-container').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      
      showToast('Logged out successfully', 'info');
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center">
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'danger' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      // Add to container
      toastContainer.appendChild(toast);
      
      // Initialize and show
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      // Remove after hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toastContainer.removeChild(toast);
      });
    }
  </script>
</body>
          </html>
