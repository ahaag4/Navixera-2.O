<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Conductor Dashboard for managing bus status, location, and ticket verification">
  <title>Conductor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
    }
    body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    .navbar {
      background: var(--card-bg);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .status-btn {
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    .status-btn:hover {
      transform: translateY(-2px);
    }
    .location-control {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
      border-radius: 12px;
    }
    .notification-item {
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    .notification-item:hover {
      background-color: #f1f5f9;
    }
    .ticket-item {
      border-left: 4px solid var(--success-color);
    }
    .ticket-valid {
      border-left-color: var(--success-color);
    }
    .ticket-invalid {
      border-left-color: var(--danger-color);
    }
    .location-updating {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    .bus-info-card {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
    }
    .flash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.3s ease;
    }
    @media (max-width: 576px) {
      .navbar-brand {
        font-size: 1.2rem;
      }
      .status-btn {
        font-size: 1rem;
        padding: 0.75rem;
      }
      .bus-info-card h2 {
        font-size: 1.5rem;
      }
      .map-display {
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Flash Screen -->
  <div class="flash-screen">
    <div class="text-center">
      <h1>Conductor Dashboard</h1>
      <div class="spinner-border text-white" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center fw-bold text-primary" href="#">
        <i class="bi bi-bus-front me-2 fs-4"></i>
        Conductor Dashboard
      </a>
      <div class="d-flex align-items-center">
        <span id="currentTime" class="text-muted me-3" aria-live="polite"></span>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle me-2"></i>
            <span id="conductorName" aria-label="Conductor name">Loading...</span>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="logoutBtn">
              <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-4">
    <!-- Bus Information -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bus-info-card p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2 class="fw-bold mb-1" id="busTitle">Loading Bus Details...</h2>
              <p class="mb-2 opacity-75" id="routeName">Fetching route information...</p>
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <span class="badge bg-light text-dark" id="currentStatus" aria-label="Bus status">Unknown</span>
                </div>
                <div class="me-3">
                  <small><i class="bi bi-people-fill me-1"></i> <span id="passengerCount">0</span>/<span id="busCapacity">0</span> capacity</small>
                </div>
                <div>
                  <small><i class="bi bi-building me-1"></i> <span id="companyName">Loading...</span></small>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-md-end">
              <h4 class="mb-1" id="currentTimeDisplay" aria-live="polite">--:-- --</h4>
              <p class="mb-0 opacity-75">Last Update: <span id="lastUpdateTime">--:--</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Control -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card location-control p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h4 class="mb-2 text-white"><i class="bi bi-geo-alt-fill me-2"></i>Location Tracking</h4>
              <p class="mb-0 text-white-50" id="locationStatusText">Click Start to begin automatic location tracking</p>
            </div>
            <div class="col-md-4 text-md-end">
              <button class="btn btn-light btn-lg me-2" id="startLocationBtn" aria-label="Start location tracking">
                <i class="bi bi-play-circle me-2"></i>Start Tracking
              </button>
              <button class="btn btn-outline-light btn-lg" id="stopLocationBtn" disabled aria-label="Stop location tracking">
                <i class="bi bi-stop-circle me-2"></i>Stop Tracking
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Left Column - Status & Location -->
      <div class="col-lg-6">
        <!-- Status Controls -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-speedometer2 me-2 text-primary"></i>Update Bus Status</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <button class="btn btn-success w-100 status-btn" data-status="On Time" aria-label="Set status to On Time">
                <i class="bi bi-check-circle-fill me-2"></i>On Time
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-warning w-100 status-btn" data-status="Delayed" aria-label="Set status to Delayed">
                <i class="bi bi-clock-history me-2"></i>Delayed
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-danger w-100 status-btn" data-status="Crowded" aria-label="Set status to Crowded">
                <i class="bi bi-people-fill me-2"></i>Crowded
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-secondary w-100 status-btn" data-status="Out of Service" aria-label="Set status to Out of Service">
                <i class="bi bi-x-circle me-2"></i>Out of Service
              </button>
            </div>
          </div>
        </div>

        <!-- Location Information -->
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-geo me-2 text-primary"></i>Live Location Data</h5>
            <span class="badge bg-success fs-6" id="locationStatusBadge" aria-label="Location status">Ready</span>
          </div>
          <div class="location-info p-3 rounded mb-3" style="background-color: #f0f9ff; border-left: 4px solid var(--primary-color);">
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-2">GPS Coordinates</h6>
                <p class="mb-1 fs-5" id="locationCoordinates">Waiting for GPS...</p>
                <small class="text-muted" id="locationAddress">Location services not active</small>
              </div>
              <div class="col-md-6 text-md-end">
                <h6 class="text-primary mb-2">Tracking Info</h6>
                <p class="mb-1">Updates Sent: <span id="locationUpdateCount" class="fw-bold">0</span></p>
                <button class="btn btn-sm btn-outline-primary mt-2" id="refreshLocationBtn" aria-label="Refresh location">
                  <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
              </div>
            </div>
          </div>
          <div class="map-display rounded mb-3" style="height: 200px; background: linear-gradient(135deg, #e2e8f0, #cbd5e1); display: flex; align-items: center; justify-content: center; color: #64748b;">
            <div class="text-center">
              <i class="bi bi-geo-alt-fill display-4 mb-3"></i>
              <p class="mb-1">Live Location Tracking</p>
              <small id="mapStatus">Location will appear here when tracking starts</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Tickets & Notifications -->
      <div class="col-lg-6">
        <!-- Ticket Verification Section -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-ticket-perforated me-2 text-primary"></i>Ticket Verification</h5>
          <div class="mb-3">
            <label for="ticketInput" class="form-label">Enter Ticket ID or Scan QR Code</label>
            <div class="input-group">
              <input type="text" class="form-control" id="ticketInput" placeholder="e.g., T123456789" aria-label="Ticket ID">
              <button class="btn btn-primary" id="verifyTicketBtn" aria-label="Verify ticket">
                <i class="bi bi-check-circle me-1"></i>Verify
              </button>
            </div>
          </div>
          <div id="ticketResult" class="d-none"></div>
          <div class="mt-3">
            <h6>Recent Ticket Checks</h6>
            <div id="recentTickets" style="max-height: 200px; overflow-y: auto;">
              <div class="text-center py-3 text-muted">
                <i class="bi bi-ticket-perforated display-6 mb-2"></i>
                <p>No recent ticket checks</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="bi bi-bell me-2 text-primary"></i>Notifications</h5>
            <span class="badge bg-primary fs-6" id="notificationCount" aria-label="Notification count">0</span>
          </div>
          <div id="notificationsList" style="max-height: 300px; overflow-y: auto;">
            <div class="text-center py-4 text-muted">
              <i class="bi bi-bell display-4 mb-3"></i>
              <p>No notifications</p>
              <small>Notifications from passengers will appear here</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Audio for Notifications -->
  <audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script>
    // DOM Elements
    const dom = {
      flashScreen: document.querySelector('.flash-screen'),
      currentTime: document.querySelector('#currentTime'),
      currentTimeDisplay: document.querySelector('#currentTimeDisplay'),
      conductorName: document.querySelector('#conductorName'),
      logoutBtn: document.querySelector('#logoutBtn'),
      busTitle: document.querySelector('#busTitle'),
      routeName: document.querySelector('#routeName'),
      currentStatus: document.querySelector('#currentStatus'),
      passengerCount: document.querySelector('#passengerCount'),
      busCapacity: document.querySelector('#busCapacity'),
      companyName: document.querySelector('#companyName'),
      lastUpdateTime: document.querySelector('#lastUpdateTime'),
      startLocationBtn: document.querySelector('#startLocationBtn'),
      stopLocationBtn: document.querySelector('#stopLocationBtn'),
      locationStatusText: document.querySelector('#locationStatusText'),
      locationStatusBadge: document.querySelector('#locationStatusBadge'),
      locationCoordinates: document.querySelector('#locationCoordinates'),
      locationAddress: document.querySelector('#locationAddress'),
      locationUpdateCount: document.querySelector('#locationUpdateCount'),
      refreshLocationBtn: document.querySelector('#refreshLocationBtn'),
      mapStatus: document.querySelector('#mapStatus'),
      ticketInput: document.querySelector('#ticketInput'),
      verifyTicketBtn: document.querySelector('#verifyTicketBtn'),
      ticketResult: document.querySelector('#ticketResult'),
      recentTickets: document.querySelector('#recentTickets'),
      notificationsList: document.querySelector('#notificationsList'),
      notificationCount: document.querySelector('#notificationCount')
    };

    // Global Variables
    let busId = null;
    let locationWatchId = null;
    let isTracking = false;
    let locationUpdateCount = 0;
    let recentTicketChecks = [];
    let lastNotifKeys = new Set();

    // Initialize Firebase
    fetch('/firebase-config')
      .then(response => response.json())
      .then(config => {
        firebase.initializeApp(config);
        initApp();
      })
      .catch(err => {
        console.error('Failed to load Firebase config:', err);
        showToast('Failed to initialize application.', 'danger');
      });

    // Initialize Application
    function initApp() {
      updateTime();
      setInterval(updateTime, 1000);
      dom.logoutBtn.addEventListener('click', logoutConductor);
      dom.startLocationBtn.addEventListener('click', startLocationTracking);
      dom.stopLocationBtn.addEventListener('click', stopLocationTracking);
      dom.refreshLocationBtn.addEventListener('click', refreshLocation);
      dom.verifyTicketBtn.addEventListener('click', verifyTicket);
      dom.ticketInput.addEventListener('keypress', e => e.key === 'Enter' && verifyTicket());
      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(btn.dataset.status));
      });

      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          initializeConductor(user);
        } else {
          showToast('Please log in to continue.', 'warning');
          setTimeout(() => window.location.href = '/login.html', 2000);
        }
      });

      setTimeout(() => {
        dom.flashScreen.style.opacity = '0';
        setTimeout(() => dom.flashScreen.remove(), 300);
      }, 1000);

      window.addEventListener('error', event => {
        showToast('An unexpected error occurred.', 'danger');
        console.error('Global error:', event.error);
      });
    }

    // Update Time
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      dom.currentTime.textContent = timeString;
      dom.currentTimeDisplay.textContent = timeString;
    }

    // Authentication
    function initializeConductor(user) {
      firebase.database().ref(`conductors/${user.uid}`).once('value')
        .then(snapshot => {
          const conductorData = snapshot.val();
          if (!conductorData || !conductorData.busId) {
            showToast('No bus assigned. Contact admin.', 'danger');
            firebase.auth().signOut();
            return;
          }
          busId = conductorData.busId;
          dom.conductorName.textContent = conductorData.name || 'Conductor';
          loadBusData();
          loadNotifications();
        })
        .catch(error => {
          console.error('Error fetching conductor data:', error);
          showToast('Error loading profile.', 'danger');
          firebase.auth().signOut();
        });
    }

    async function logoutConductor() {
      try {
        if (locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
        await firebase.auth().signOut();
        showToast('Logged out successfully.', 'info');
      } catch (error) {
        console.error('Logout error:', error);
        showToast('Error logging out.', 'danger');
      }
    }

    // Bus Data
    function loadBusData() {
      if (!busId) {
        showToast('No bus assigned.', 'danger');
        return;
      }
      firebase.database().ref(`public_transport/vehicles/${busId}`).on('value', snapshot => {
        const busData = snapshot.val();
        if (busData) {
          dom.busTitle.textContent = `Bus: ${busId}`;
          dom.routeName.textContent = busData.routeName || 'Route not specified';
          dom.currentStatus.textContent = busData.status || 'Unknown';
          dom.passengerCount.textContent = busData.currentPassengers || '0';
          dom.busCapacity.textContent = busData.capacity || '0';
          dom.companyName.textContent = busData.companyName || 'Not specified';
          if (busData.lastUpdated) {
            dom.lastUpdateTime.textContent = new Date(busData.lastUpdated).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          }
        } else {
          showToast(`Bus ${busId} not found.`, 'danger');
          dom.busTitle.textContent = `Bus: ${busId} (Not Found)`;
          dom.routeName.textContent = 'No route information';
          dom.currentStatus.textContent = 'Unknown';
          dom.passengerCount.textContent = '0';
          dom.busCapacity.textContent = '0';
          dom.companyName.textContent = 'Not specified';
          dom.lastUpdateTime.textContent = '--:--';
        }
      });
    }

    async function updateStatus(status) {
      if (!busId) return;
      try {
        await firebase.database().ref(`public_transport/vehicles/${busId}`).update({
          status,
          lastUpdated: Date.now()
        });
        showToast(`Status updated to: ${status}`, 'success');
        dom.lastUpdateTime.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch (error) {
        console.error('Error updating status:', error);
        showToast('Error updating status.', 'danger');
      }
    }

    // Location Tracking
    function startLocationTracking() {
      if (!navigator.geolocation) {
        showToast('Geolocation not supported.', 'danger');
        return;
      }
      if (isTracking) {
        showToast('Location tracking already active.', 'info');
        return;
      }
      dom.startLocationBtn.disabled = true;
      dom.stopLocationBtn.disabled = false;
      dom.locationStatusText.textContent = 'Automatic location tracking active';
      dom.locationStatusBadge.textContent = 'Tracking';
      dom.locationStatusBadge.className = 'badge bg-warning fs-6';
      dom.mapStatus.textContent = 'Tracking location in real-time...';
      showToast('Starting location tracking...', 'info');

      locationWatchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          locationUpdateCount++;
          updateLocationUI(latitude, longitude);
          updateBusLocation(latitude, longitude);
        },
        error => {
          console.error('Location error:', error);
          let errorMessage = 'Unknown location error';
          switch (error.code) {
            case error.PERMISSION_DENIED: errorMessage = 'Location access denied'; break;
            case error.POSITION_UNAVAILABLE: errorMessage = 'Location unavailable'; break;
            case error.TIMEOUT: errorMessage = 'Location request timed out'; break;
          }
          dom.locationStatusBadge.textContent = 'Error';
          dom.locationStatusBadge.className = 'badge bg-danger fs-6';
          dom.mapStatus.textContent = errorMessage;
          showToast(errorMessage, 'danger');
        },
        { enableHighAccuracy: true, maximumAge: 3000, timeout: 10000 }
      );
      isTracking = true;
      showToast('Location tracking started.', 'success');
    }

    function stopLocationTracking() {
      if (!isTracking) {
        showToast('Location tracking not active.', 'info');
        return;
      }
      if (locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
      dom.startLocationBtn.disabled = false;
      dom.stopLocationBtn.disabled = true;
      dom.locationStatusText.textContent = 'Location tracking stopped';
      dom.locationStatusBadge.textContent = 'Stopped';
      dom.locationStatusBadge.className = 'badge bg-secondary fs-6';
      dom.mapStatus.textContent = 'Location tracking stopped';
      isTracking = false;
      showToast('Location tracking stopped.', 'info');
    }

    function refreshLocation() {
      if (!navigator.geolocation) {
        showToast('Geolocation not available.', 'danger');
        return;
      }
      dom.locationStatusBadge.textContent = 'Updating...';
      dom.locationStatusBadge.className = 'badge bg-warning fs-6 location-updating';
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          updateLocationUI(latitude, longitude);
          updateBusLocation(latitude, longitude);
          showToast('Location refreshed.', 'success');
        },
        error => {
          console.error('Location error:', error);
          dom.locationStatusBadge.textContent = 'Error';
          dom.locationStatusBadge.className = 'badge bg-danger fs-6';
          showToast('Failed to get location.', 'danger');
        }
      );
    }

    function updateLocationUI(latitude, longitude) {
      dom.locationCoordinates.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      dom.locationStatusBadge.textContent = 'Active';
      dom.locationStatusBadge.className = 'badge bg-success fs-6';
      dom.locationUpdateCount.textContent = locationUpdateCount;
      dom.lastUpdateTime.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      getAddressFromCoords(latitude, longitude);
    }

    async function updateBusLocation(latitude, longitude) {
      if (!busId) return;
      try {
        await firebase.database().ref(`public_transport/vehicles/${busId}`).update({
          gps: `${latitude}, ${longitude}`,
          lastLocationUpdate: Date.now()
        });
      } catch (error) {
        console.error('Error updating location:', error);
        showToast('Error updating location.', 'danger');
      }
    }

    async function getAddressFromCoords(lat, lng) {
      try {
        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const data = await response.json();
        dom.locationAddress.textContent = data.locality || data.principalSubdivision || 'Unknown location';
      } catch (error) {
        console.error('Error fetching address:', error);
        dom.locationAddress.textContent = 'Unable to fetch address';
      }
    }

    // Ticket Verification
    async function verifyTicket() {
      const ticketId = dom.ticketInput.value.trim().toUpperCase();
      if (!ticketId) {
        showToast('Please enter a ticket ID.', 'warning');
        return;
      }
      dom.ticketResult.className = 'ticket-item p-3 rounded mb-3';
      dom.ticketResult.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary mb-2" role="status">
            <span class="visually-hidden">Verifying ticket...</span>
          </div>
          <p>Verifying ticket...</p>
        </div>
      `;
      dom.ticketResult.classList.remove('d-none');

      try {
        const usersSnapshot = await firebase.database().ref('users').once('value');
        let ticketData = null;
        let passengerName = 'Unknown';
        let userId = null;

        usersSnapshot.forEach(userSnap => {
          const tickets = userSnap.val().tickets || [];
          const ticket = tickets.find(t => t.id === ticketId);
          if (ticket) {
            ticketData = ticket;
            passengerName = userSnap.val().name || 'Unknown';
            userId = userSnap.key;
          }
        });

        if (!ticketData) {
          displayTicketResult({ id: ticketId, isValid: false });
          addToRecentTickets({ id: ticketId, isValid: false });
          showToast('Ticket not found.', 'danger');
          return;
        }

        const isValid = ticketData.busId === busId &&
                        ticketData.status === 'active' &&
                        ticketData.validUntil > Date.now();

        const result = {
          id: ticketId,
          passengerName,
          from: ticketData.fromStop,
          to: ticketData.toStop,
          fare: `₹${ticketData.fare.toFixed(2)}`,
          validUntil: new Date(ticketData.validUntil).toLocaleString(),
          isValid,
          passengers: ticketData.passengers || 1
        };

        displayTicketResult(result);
        addToRecentTickets(result);

        if (isValid && userId) {
          const tickets = (await firebase.database().ref(`users/${userId}/tickets`).once('value')).val() || [];
          const updatedTickets = tickets.map(t => t.id === ticketId ? { ...t, status: 'used' } : t);
          await firebase.database().ref(`users/${userId}/tickets`).set(updatedTickets);
        }

        showToast(isValid ? 'Ticket verified successfully.' : 'Invalid or expired ticket.', isValid ? 'success' : 'danger');
        dom.ticketInput.value = '';
      } catch (error) {
        console.error('Error verifying ticket:', error);
        showToast('Error verifying ticket.', 'danger');
        displayTicketResult({ id: ticketId, isValid: false });
        addToRecentTickets({ id: ticketId, isValid: false });
      }
    }

    function displayTicketResult(ticketData) {
      const statusClass = ticketData.isValid ? 'ticket-valid' : 'ticket-invalid';
      const statusIcon = ticketData.isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
      const statusText = ticketData.isValid ? 'VALID TICKET' : 'INVALID TICKET';
      dom.ticketResult.className = `ticket-item p-3 rounded mb-3 ${statusClass}`;
      dom.ticketResult.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="mb-0">${statusText}</h5>
          <i class="bi ${statusIcon} fs-4"></i>
        </div>
        ${ticketData.isValid ? `
          <div class="row">
            <div class="col-6">
              <small class="text-muted d-block">Passenger</small>
              <strong>${ticketData.passengerName}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Ticket ID</small>
              <strong>${ticketData.id}</strong>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-6">
              <small class="text-muted d-block">Route</small>
              <strong>${ticketData.from} → ${ticketData.to}</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Fare</small>
              <strong>${ticketData.fare}</strong>
            </div>
          </div>
          <div class="mt-2">
            <small class="text-muted d-block">Valid Until</small>
            <strong>${ticketData.validUntil}</strong>
          </div>
          <div class="mt-2">
            <small class="text-muted d-block">Passengers</small>
            <strong>${ticketData.passengers}</strong>
          </div>
        ` : `
          <p class="mb-0">This ticket is not valid or has expired.</p>
          <small class="text-muted">Please ask passenger to purchase a valid ticket.</small>
        `}
      `;
    }

    function addToRecentTickets(ticketData) {
      recentTicketChecks.unshift({
        ...ticketData,
        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      });
      if (recentTicketChecks.length > 5) recentTicketChecks = recentTicketChecks.slice(0, 5);
      updateRecentTicketsUI();
    }

    function updateRecentTicketsUI() {
      if (recentTicketChecks.length === 0) {
        dom.recentTickets.innerHTML = `
          <div class="text-center py-3 text-muted">
            <i class="bi bi-ticket-perforated display-6 mb-2"></i>
            <p>No recent ticket checks</p>
          </div>
        `;
        return;
      }
      let html = '';
      recentTicketChecks.forEach(ticket => {
        const statusIcon = ticket.isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
        html += `
          <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
              <i class="bi ${statusIcon} me-2"></i>
              <strong>${ticket.id}</strong>
              <br>
              <small class="text-muted">${ticket.timestamp}</small>
            </div>
            <div class="text-end">
              <small class="${ticket.isValid ? 'text-success' : 'text-danger'} fw-bold">
                ${ticket.isValid ? 'VALID' : 'INVALID'}
              </small>
            </div>
          </div>
        `;
      });
      dom.recentTickets.innerHTML = html;
    }

    // Notifications
    function loadNotifications() {
      if (!busId) return;
      firebase.database().ref(`public_transport/vehicles/${busId}/notifications`).on('value', snapshot => {
        dom.notificationsList.innerHTML = '';
        let count = 0;
        const notifications = [];
        snapshot.forEach(child => {
          const key = child.key;
          const notif = child.val();
          notifications.push({ key, notif });
          count++;
        });
        notifications.sort((a, b) => b.notif.timestamp - a.notif.timestamp);
        if (notifications.length === 0) {
          dom.notificationsList.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="bi bi-bell display-4 mb-3"></i>
              <p>No notifications</p>
              <small>Notifications from passengers will appear here</small>
            </div>
          `;
        } else {
          notifications.forEach(({ key, notif }) => {
            const notifElement = document.createElement('div');
            notifElement.className = 'notification-item p-3 mb-2 rounded';
            let iconClass = 'bi-info-circle text-primary';
            if (notif.type === 'lost_bag') iconClass = 'bi-bag-x text-danger';
            else if (notif.type === 'safety_alert') iconClass = 'bi-shield-exclamation text-warning';
            notifElement.innerHTML = `
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <i class="bi ${iconClass} fs-5"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h6 class="mb-1">${notif.type ? notif.type.replace('_', ' ').toUpperCase() : 'Notification'}</h6>
                  <p class="mb-1 small">${notif.description || 'New notification'}</p>
                  <small class="text-muted">${formatTime(notif.timestamp)}</small>
                </div>
              </div>
            `;
            dom.notificationsList.appendChild(notifElement);
            if (!lastNotifKeys.has(key)) {
              document.getElementById('notifSound').play().catch(() => {});
              showToast('New notification received.', 'info');
            }
            lastNotifKeys.add(key);
          });
        }
        dom.notificationCount.textContent = count;
      });
    }

    // Utilities
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center">
            <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : type === 'danger' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toastContainer.removeChild(toast));
    }

    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      const now = Date.now();
      const diff = now - timestamp;
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
      return `${Math.floor(diff / 86400000)} days ago`;
    }
  </script>
</body>
</html>
